<!DOCTYPE html>
<html>
<head>
    <title>Transfer Function Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; margin: 20px 0; }
        td, th { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f0f0f0; }
        .controls { margin: 20px 0; padding: 15px; background-color: #f9f9f9; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 8px 15px; margin: 5px; }
        select { padding: 5px; margin: 0 10px; }
    </style>
</head>
<body>
    <h1>Transfer Function Test</h1>
    
    <div class="test-section">
        <h2>Test Data Setup</h2>
        <button onclick="addTestData()">Add Test Data</button>
        <button onclick="clearAllData()">Clear All Data</button>
        <button onclick="addFormattedData()">Add Formatted Numbers</button>
    </div>

    <h2>North Table (S11-S22)</h2>
    <table>
        <tr>
            <th>Module</th>
            <th>Volume</th>
        </tr>
        <tr class="volSwap">
            <td>S11</td>
            <td id="S11_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S12</td>
            <td id="S12_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S13</td>
            <td id="S13_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S14</td>
            <td id="S14_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S15</td>
            <td id="S15_Vol" class="value">&nbsp;</td>
        </tr>
    </table>

    <h2>South Table (S01-S10)</h2>
    <table>
        <tr>
            <th>Module</th>
            <th>Volume</th>
        </tr>
        <tr class="volSwap">
            <td>S01</td>
            <td id="S01_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S02</td>
            <td id="S02_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S03</td>
            <td id="S03_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S04</td>
            <td id="S04_Vol" class="value">&nbsp;</td>
        </tr>
        <tr class="volSwap">
            <td>S05</td>
            <td id="S05_Vol" class="value">&nbsp;</td>
        </tr>
    </table>

    <div class="controls">
        <h2>Transfer Controls</h2>
        <label>Source:</label>
        <select id="sourceSelect">
            <option value="S01_Vol">S01</option>
            <option value="S02_Vol">S02</option>
            <option value="S03_Vol">S03</option>
            <option value="S04_Vol">S04</option>
            <option value="S05_Vol">S05</option>
            <option value="S11_Vol">S11</option>
            <option value="S12_Vol">S12</option>
            <option value="S13_Vol">S13</option>
            <option value="S14_Vol">S14</option>
            <option value="S15_Vol">S15</option>
        </select>

        <label>Target:</label>
        <select id="targetSelect">
            <option value="S01_Vol">S01</option>
            <option value="S02_Vol">S02</option>
            <option value="S03_Vol">S03</option>
            <option value="S04_Vol">S04</option>
            <option value="S05_Vol">S05</option>
            <option value="S11_Vol">S11</option>
            <option value="S12_Vol">S12</option>
            <option value="S13_Vol">S13</option>
            <option value="S14_Vol">S14</option>
            <option value="S15_Vol">S15</option>
        </select>

        <button onclick="transferValue()">Transfer</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>

    <script>
        // FIXED TRANSFER FUNCTION
        function transferValue() {
            const sourceLabel = document.getElementById("sourceSelect").value;
            const targetLabel = document.getElementById("targetSelect").value;

            if (sourceLabel === targetLabel) {
                alert("Source and target must be different.");
                return;
            }

            // Find the actual table cells by ID
            const sourceCell = document.getElementById(sourceLabel);
            const targetCell = document.getElementById(targetLabel);

            if (!sourceCell || !targetCell) {
                alert("Could not find source or target cell.");
                return;
            }

            // Get values, handling &nbsp; and empty cases
            const sourceText = sourceCell.textContent.trim();
            const targetText = targetCell.textContent.trim();

            // Handle &nbsp; (both regular space and non-breaking space), empty strings, and formatted numbers
            const sourceValue = (sourceText === "" || sourceText === "\u00A0" || sourceText === "&nbsp;") ? 0 : parseInt(sourceText.replace(/,/g, ''));
            const targetValue = (targetText === "" || targetText === "\u00A0" || targetText === "&nbsp;") ? 0 : parseInt(targetText.replace(/,/g, ''));

            if (isNaN(sourceValue) || isNaN(targetValue)) {
                alert("Invalid values found in source or target cells.");
                return;
            }

            // Log the transfer for testing
            logTransfer(sourceLabel, targetLabel, sourceValue, targetValue);

            // Perform the transfer
            targetCell.textContent = (targetValue + sourceValue).toLocaleString();
            sourceCell.textContent = "0";
        }

        // TEST HELPER FUNCTIONS
        function addTestData() {
            document.getElementById("S01_Vol").textContent = "1,000";
            document.getElementById("S02_Vol").textContent = "2,500";
            document.getElementById("S03_Vol").textContent = "&nbsp;";
            document.getElementById("S04_Vol").textContent = "500";
            document.getElementById("S05_Vol").textContent = "";
            
            document.getElementById("S11_Vol").textContent = "3,200";
            document.getElementById("S12_Vol").textContent = "1,800";
            document.getElementById("S13_Vol").textContent = "&nbsp;";
            document.getElementById("S14_Vol").textContent = "750";
            document.getElementById("S15_Vol").textContent = "4,100";
        }

        function addFormattedData() {
            document.getElementById("S01_Vol").textContent = "12,345";
            document.getElementById("S02_Vol").textContent = "67,890";
            document.getElementById("S11_Vol").textContent = "98,765";
            document.getElementById("S12_Vol").textContent = "43,210";
        }

        function clearAllData() {
            const cells = ["S01_Vol", "S02_Vol", "S03_Vol", "S04_Vol", "S05_Vol", 
                          "S11_Vol", "S12_Vol", "S13_Vol", "S14_Vol", "S15_Vol"];
            cells.forEach(id => {
                document.getElementById(id).textContent = "&nbsp;";
            });
            document.getElementById("testResults").innerHTML = "";
        }

        function logTransfer(source, target, sourceVal, targetVal) {
            const resultDiv = document.getElementById("testResults");
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML += `<p><strong>[${timestamp}]</strong> Transfer: ${source} (${sourceVal.toLocaleString()}) → ${target} (${targetVal.toLocaleString()}) = ${(sourceVal + targetVal).toLocaleString()}</p>`;
        }

        // Run automated tests
        function runAutomatedTests() {
            console.log("Running automated tests...");
            
            // Test 1: Basic transfer
            addTestData();
            console.log("Test 1: Basic transfer S01→S02");
            document.getElementById("sourceSelect").value = "S01_Vol";
            document.getElementById("targetSelect").value = "S02_Vol";
            transferValue();
            
            // Test 2: Transfer from empty cell
            console.log("Test 2: Transfer from empty S03→S04");
            document.getElementById("sourceSelect").value = "S03_Vol";
            document.getElementById("targetSelect").value = "S04_Vol";
            transferValue();
            
            // Test 3: Cross-table transfer (North to South)
            console.log("Test 3: Cross-table transfer S11→S05");
            document.getElementById("sourceSelect").value = "S11_Vol";
            document.getElementById("targetSelect").value = "S05_Vol";
            transferValue();
        }
    </script>

    <div class="test-section">
        <h2>Automated Testing</h2>
        <button onclick="runAutomatedTests()">Run Automated Tests</button>
        <p>Check browser console (F12) for test results</p>
    </div>

</body>
</html>