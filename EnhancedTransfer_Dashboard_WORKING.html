<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head runat="server">


    <link rel="icon" href="build/images/UPS.png" type="image/ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <link rel="stylesheet" href="build/css/w3.css">
    <link rel="stylesheet" href="build/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="build/css/jquery.dataTables.css">
    <!-- Use CDN for critical dependencies to ensure they load -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <!-- Fallback to local files if CDN fails -->
    <script>
        window.jQuery || document.write('<script src="build/js/jquery.min.js"><\/script>');
    </script>

    <link rel="stylesheet" type="text/css" media="screen"
        href="./Vendors/trirand_jqGrid/css/trirand/ui.jqgrid-bootstrap4.css" />
    <!-- jqGid bootstrap version-->
    <!-- Optional scripts - wrapped in error handling to prevent blocking -->
    <script>
        // Function to safely load optional scripts
        function safeLoadScript(src, description) {
            var script = document.createElement('script');
            script.src = src;
            script.onerror = function() {
                console.warn('Optional script failed to load:', description, src);
            };
            document.head.appendChild(script);
        }

        // Load optional scripts that may not exist
        safeLoadScript('./Vendors/trirand_jqGrid/js/trirand/i18n/grid.locale-en.js', 'jqGrid locale');
        safeLoadScript('./Vendors/trirand_jqGrid/js/trirand/jquery.jqGrid.min.js', 'jqGrid main');
        safeLoadScript('build/js/jquery.dataTables.js', 'DataTables');
        safeLoadScript('build/js/echarts.min.js', 'ECharts');
        safeLoadScript('vendors/datatables.net-buttons/js/dataTables.buttons.min.js', 'DataTables buttons');
        safeLoadScript('vendors/datatables.net-buttons/js/buttons.print.min.js', 'DataTables print');
        safeLoadScript('vendors/pdfmake/build/pdfmake.min.js', 'PDFMake');
        safeLoadScript('vendors/pdfmake/build/vfs_fonts.js', 'PDFMake fonts');
        safeLoadScript('vendors/datatables.net-buttons/js/buttons.html5.min.js', 'DataTables HTML5');
        safeLoadScript('vendors/jszip/dist/jszip.min.js', 'JSZip');
    </script>

    <!-- Keep CSS links as they fail silently -->
    <link rel="stylesheet" type="text/css" href="vendors/datatables.net-buttons/buttons.dataTables.css">


    <style>
        body {
            background-color: black;
            color: black;
            zoom: 70%;
        }

        #table1 td {
            border: none;
        }

        td {
            text-align: center;
            border: 1px solid gray;
        }

        th {
            text-align: center;
            font-weight: bold;
            border: 2px solid white;

        }

        #South th {
            text-align: center;
            font-weight: bold;
            border: 2px solid white;
            background: steelblue;
        }

        #North th {
            text-align: center;
            font-weight: bold;
            border: 2px solid white;
            background: rgba(255, 140, 0, 0.636);
        }

        /* Apply alternate column colors */
        tr:nth-child(even) {
            background-color: #aab0b6;
            /* old color: #343a40; */
        }

        tr:nth-child(odd) {
            background-color: #a7b4c1c4;
            /* old color: #454d55; */
        }

        .rowhead {
            text-align: center;
        }
    </style>

</head>

<body>

    <div class="container">

        <div id="dt" class='float-right'> now </div>

        <br />
        <table id="table1" class="display" style="width:100%;">
            <tr>
                <td class="dropdown-wrapper" style="background-color: black;">
                    <select name="sortSel" id="sortSel">
                    </select>

                </td>
                <button onclick="openPrintDialog()"
                    style="margin-left: auto; margin-right: auto; padding: 6px; border: 4px solid red;">Print</button>
                <button onclick="addSampleDataForTesting()"
                    style="margin-left: 10px; padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">ðŸŽ² Add Sample Data</button>
            </tr>
        </table>

        <br />
        <div class="row">
            <!-- old uptime % table position | 10/4/24 | W.Rodriguez -->
            <div class="col-lg">
                <style>
                    h2 {
                        text-align: center;
                        border-style: solid;
                        margin-bottom: -4px;
                        padding: 4px;
                    }
                </style>
                <h2 style="color: white;">Building Hourly Quicklook</h2>
                <table id="HourlyTable" class="display" style="width:100%">

                    <!-- This section is a half hour table without a DELTA calculation. Stored Procedure intervals need to be modified to 30 minutes if this is used.-->
                    <tr>
                        <th scope="col">Start Time + </th>
                        <th scope="col">0.5 Hour</th>
                        <th scope="col">1st Hour</th>
                        <th scope="col">1.5 Hour</th>
                        <th scope="col">2nd Hour</th>
                        <th scope="col">2.5 Hour</th>
                        <th scope="col">3rd Hour</th>
                        <th scope="col">3.5 Hour</th>
                        <th scope="col">4th Hour</th>
                        <th scope="col">4.5 Hour</th>
                        <th scope="col">5th Hour</th>
                        <th scope="col">5.5 Hour</th>
                        <th scope="col">6th Hour</th>
                        <th scope="col">Final</th>
                    </tr>
                    <tr>
                        <td class="rowhead">TIME STAMP</td>
                        <td id="1_TS" class="rowhead">&nbsp;</td>
                        <td id="2_TS" class="rowhead">&nbsp;</td>
                        <td id="3_TS" class="rowhead">&nbsp;</td>
                        <td id="4_TS" class="rowhead">&nbsp;</td>
                        <td id="5_TS" class="rowhead">&nbsp;</td>
                        <td id="6_TS" class="rowhead">&nbsp;</td>
                        <td id="7_TS" class="rowhead">&nbsp;</td>
                        <td id="8_TS" class="rowhead">&nbsp;</td>
                        <td id="9_TS" class="rowhead">&nbsp;</td>
                        <td id="10_TS" class="rowhead">&nbsp;</td>
                        <td id="11_TS" class="rowhead">&nbsp;</td>
                        <td id="12_TS" class="rowhead">&nbsp;</td>
                        <td id="99_TS" class="rowhead">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">BUILDING VOL</td>
                        <td id="1_BUILDVol">&nbsp;</td>
                        <td id="2_BUILDVol">&nbsp;</td>
                        <td id="3_BUILDVol">&nbsp;</td>
                        <td id="4_BUILDVol">&nbsp;</td>
                        <td id="5_BUILDVol">&nbsp;</td>
                        <td id="6_BUILDVol">&nbsp;</td>
                        <td id="7_BUILDVol">&nbsp;</td>
                        <td id="8_BUILDVol">&nbsp;</td>
                        <td id="9_BUILDVol">&nbsp;</td>
                        <td id="10_BUILDVol">&nbsp;</td>
                        <td id="11_BUILDVol">&nbsp;</td>
                        <td id="12_BUILDVol">&nbsp;</td>
                        <td id="99_BUILDVol">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">PRIMARY VOL</td>
                        <td id="1_PriVol">&nbsp;</td>
                        <td id="2_PriVol">&nbsp;</td>
                        <td id="3_PriVol">&nbsp;</td>
                        <td id="4_PriVol">&nbsp;</td>
                        <td id="5_PriVol">&nbsp;</td>
                        <td id="6_PriVol">&nbsp;</td>
                        <td id="7_PriVol">&nbsp;</td>
                        <td id="8_PriVol">&nbsp;</td>
                        <td id="9_PriVol">&nbsp;</td>
                        <td id="10_PriVol">&nbsp;</td>
                        <td id="11_PriVol">&nbsp;</td>
                        <td id="12_PriVol">&nbsp;</td>
                        <td id="99_PriVol">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">EXCEPTION VOL</td>
                        <td id="1_ExVol">&nbsp;</td>
                        <td id="2_ExVol">&nbsp;</td>
                        <td id="3_ExVol">&nbsp;</td>
                        <td id="4_ExVol">&nbsp;</td>
                        <td id="5_ExVol">&nbsp;</td>
                        <td id="6_ExVol">&nbsp;</td>
                        <td id="7_ExVol">&nbsp;</td>
                        <td id="8_ExVol">&nbsp;</td>
                        <td id="9_ExVol">&nbsp;</td>
                        <td id="10_ExVol">&nbsp;</td>
                        <td id="11_ExVol">&nbsp;</td>
                        <td id="12_ExVol">&nbsp;</td>
                        <td id="99_ExVol">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">OUTBOUND VOL</td>
                        <td id="1_OBVol">&nbsp;</td>
                        <td id="2_OBVol">&nbsp;</td>
                        <td id="3_OBVol">&nbsp;</td>
                        <td id="4_OBVol">&nbsp;</td>
                        <td id="5_OBVol">&nbsp;</td>
                        <td id="6_OBVol">&nbsp;</td>
                        <td id="7_OBVol">&nbsp;</td>
                        <td id="8_OBVol">&nbsp;</td>
                        <td id="9_OBVol">&nbsp;</td>
                        <td id="10_OBVol">&nbsp;</td>
                        <td id="11_OBVol">&nbsp;</td>
                        <td id="12_OBVol">&nbsp;</td>
                        <td id="99_OBVol">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">SMALLS VOL</td>
                        <td id="1_BFVol">&nbsp;</td>
                        <td id="2_BFVol">&nbsp;</td>
                        <td id="3_BFVol">&nbsp;</td>
                        <td id="4_BFVol">&nbsp;</td>
                        <td id="5_BFVol">&nbsp;</td>
                        <td id="6_BFVol">&nbsp;</td>
                        <td id="7_BFVol">&nbsp;</td>
                        <td id="8_BFVol">&nbsp;</td>
                        <td id="9_BFVol">&nbsp;</td>
                        <td id="10_BFVol">&nbsp;</td>
                        <td id="11_BFVol">&nbsp;</td>
                        <td id="12_BFVol">&nbsp;</td>
                        <td id="99_BFVol">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">SMALLS %</td>
                        <td id="1_BFVolPct">&nbsp;</td>
                        <td id="2_BFVolPct">&nbsp;</td>
                        <td id="3_BFVolPct">&nbsp;</td>
                        <td id="4_BFVolPct">&nbsp;</td>
                        <td id="5_BFVolPct">&nbsp;</td>
                        <td id="6_BFVolPct">&nbsp;</td>
                        <td id="7_BFVolPct">&nbsp;</td>
                        <td id="8_BFVolPct">&nbsp;</td>
                        <td id="9_BFVolPct">&nbsp;</td>
                        <td id="10_BFVolPct">&nbsp;</td>
                        <td id="11_BFVolPct">&nbsp;</td>
                        <td id="12_BFVolPct">&nbsp;</td>
                        <td id="99_BFVolPct">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">OB CHUTE FULL</td>
                        <td id="1_CF">&nbsp;</td>
                        <td id="2_CF">&nbsp;</td>
                        <td id="3_CF">&nbsp;</td>
                        <td id="4_CF">&nbsp;</td>
                        <td id="5_CF">&nbsp;</td>
                        <td id="6_CF">&nbsp;</td>
                        <td id="7_CF">&nbsp;</td>
                        <td id="8_CF">&nbsp;</td>
                        <td id="9_CF">&nbsp;</td>
                        <td id="10_CF">&nbsp;</td>
                        <td id="11_CF">&nbsp;</td>
                        <td id="12_CF">&nbsp;</td>
                        <td id="99_CF">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">BELT STOPS</td>
                        <td id="1_BS">&nbsp;</td>
                        <td id="2_BS">&nbsp;</td>
                        <td id="3_BS">&nbsp;</td>
                        <td id="4_BS">&nbsp;</td>
                        <td id="5_BS">&nbsp;</td>
                        <td id="6_BS">&nbsp;</td>
                        <td id="7_BS">&nbsp;</td>
                        <td id="8_BS">&nbsp;</td>
                        <td id="9_BS">&nbsp;</td>
                        <td id="10_BS">&nbsp;</td>
                        <td id="11_BS">&nbsp;</td>
                        <td id="12_BS">&nbsp;</td>
                        <td id="99_BS">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">DEFECTS %</td>
                        <td id="1_DEFPct">&nbsp;</td>
                        <td id="2_DEFPct">&nbsp;</td>
                        <td id="3_DEFPct">&nbsp;</td>
                        <td id="4_DEFPct">&nbsp;</td>
                        <td id="5_DEFPct">&nbsp;</td>
                        <td id="6_DEFPct">&nbsp;</td>
                        <td id="7_DEFPct">&nbsp;</td>
                        <td id="8_DEFPct">&nbsp;</td>
                        <td id="9_DEFPct">&nbsp;</td>
                        <td id="10_DEFPct">&nbsp;</td>
                        <td id="11_DEFPct">&nbsp;</td>
                        <td id="12_DEFPct">&nbsp;</td>
                        <td id="99_DEFPct">&nbsp;</td>
                    </tr>

                    <tr>
                        <td class="rowhead">PRI NO READ %</td>
                        <td id="1_PNRPct">&nbsp;</td>
                        <td id="2_PNRPct">&nbsp;</td>
                        <td id="3_PNRPct">&nbsp;</td>
                        <td id="4_PNRPct">&nbsp;</td>
                        <td id="5_PNRPct">&nbsp;</td>
                        <td id="6_PNRPct">&nbsp;</td>
                        <td id="7_PNRPct">&nbsp;</td>
                        <td id="8_PNRPct">&nbsp;</td>
                        <td id="9_PNRPct">&nbsp;</td>
                        <td id="10_PNRPct">&nbsp;</td>
                        <td id="11_PNRPct">&nbsp;</td>
                        <td id="12_PNRPct">&nbsp;</td>
                        <td id="99_PNRPct">&nbsp;</td>
                    </tr>
                </table>
                <!-- New primary stats edits | 10/4/24 | W.Rodriguez | table id="PrimaryStatsTable" -->
                <h3> </h3>
                <table id="Primary" class="display" style="width:100%">
                    <tr>
                        <th scope="col"></th>
                        <th scope="col">NW</th>
                        <th scope="col">NE</th>
                        <th scope="col">SW</th>
                        <th scope="col">SE</th>
                        <th scope="col">Total Pri</th>
                    </tr>
                    <tr>
                        <td class="rowhead">No Read %</td>
                        <td id="NW_NoReadsPct" class="rowhead"></td>
                        <td id="NE_NoReadsPct" class="rowhead"></td>
                        <td id="SW_NoReadsPct" class="rowhead"></td>
                        <td id="SE_NoReadsPct" class="rowhead"></td>
                        <td id="Total_NoReadsPct" class="rowhead"></td>

                    </tr>
                    <tr>
                        <td class="rowhead">Belt Stops</td>
                        <td id="NW_BeltStops" class="rowhead"></td>
                        <td id="NE_BeltStops" class="rowhead"></td>
                        <td id="SW_BeltStops" class="rowhead"></td>
                        <td id="SE_BeltStops" class="rowhead"></td>
                        <td id="Total_BeltStops" class="rowhead"></td>
                    </tr>
                    <tr>
                        <td class="rowhead">Volume</td>
                        <td id="NW_InputVolume" class="rowhead"></td>
                        <td id="NE_InputVolume" class="rowhead"></td>
                        <td id="SW_InputVolume" class="rowhead"></td>
                        <td id="SE_InputVolume" class="rowhead"></td>
                        <td id="Total_InputVolume" class="rowhead"></td>
                    </tr>

                </table>
                <!-- New primary stats edits | 10/4/24 | W.Rodriguez -->
            </div>
            <!-- New SS  edits | 10/8/24 | W.Rodriguez -->
            <table id="Smalls" class="display" style="margin-left: auto; margin-right: auto;">
                <th id="Smalls th" colspan="5">Small Sort Uptime %</th>
                <tr>
                    <!--id="OB01_UTPct" "SLS01_UPT" -->
                    <td style="padding: 6px;">SLS01</td>
                    <td id="BF1_UTPct" class="rowhead" style="padding: 6px;"></td>
                    <td style="padding: 6px;">SS1</td>
                    <td id="SS1F1_UTPct" class="rowhead" style="padding: 6px;"></td>
                </tr>
                <tr>
                    <td>SLS02</td>
                    <td id="BF2_UTPct" class="rowhead">&nbsp;</td>
                    <td>SS3</td>
                    <td id="SS3F1_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS03</td>
                    <td id="SLS03_UTPct" class="rowhead">&nbsp;</td>
                    <td>SS4</td>
                    <td id="SS4F1_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS04</td>
                    <td id="SLS04_UTPct" class="rowhead">&nbsp;</td>
                    <td>SSR1</td>
                    <td id="SSR1_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS05</td>
                    <td id="SLS05_UTPct" class="rowhead">&nbsp;</td>
                    <td>SSR2</td>
                    <td id="SSR2_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS06</td>
                    <td id="SLS06_UTPct" class="rowhead">&nbsp;</td>
                    <td>SSR3</td>
                    <td id="SSR3_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS07</td>
                    <td id="SLS07_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td id="" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS08</td>
                    <td id="SLS08_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td id="SSSR1_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS09</td>
                    <td id="BF9_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td id="SSSR2_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS10</td>
                    <td id="SLS10_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td id="SSSR3_UTPct" class="rowhead">&nbsp;</td>
                </tr>
                <tr>
                    <td>SLS11</td>
                    <td id="SLS11_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>SLS12</td>
                    <td id="SLS12_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>SLS13</td>
                    <td id="SLS13_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>SLS14</td>
                    <td id="SLS14_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>SLS15</td>
                    <td id="SLS15_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>SLS16</td>
                    <td id="SLS16_UTPct" class="rowhead">&nbsp;</td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            <!-- New SS edits | 10/8/24 | W.Rodriguez -->
        </div>
    </div>
    <div>
        <style>
            /* Container for tables and buttons */
            /* Adjust table styles */
            .table-container {
                display: flex;
                justify-content: space-between;
                margin: 0 auto;
                /* Center the tables */
                margin-top: 2%
            }

            /* Set the width of each table */
            .table-container table {
                width: 500%;
                margin-right: 3%;
            }

            /* Add a gap between the two tables */
            .table-container table:first-child {
                margin-left: 3%;
                margin-right: 1%;
            }

            /* Button styles */
            .buttons-column {
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                /* Align buttons to the start of the column */
            }

            .button {
                margin-top: 3px;
                width: 80px;
                cursor: pointer;

            }

            .button.active {
                background-color: #007bff;
                color: #fff;
            }

            .center1 {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
            }

            /* ENHANCED TRANSFER CONTROLS STYLING */
            .transfer-section {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                padding: 25px;
                margin: 30px auto;
                border-radius: 12px;
                border: 3px solid #3498db;
                box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
                max-width: 800px;
                position: relative;
                overflow: hidden;
            }

            .transfer-section::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
                animation: shimmer 3s infinite;
            }

            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 100%; }
            }

            .transfer-section h3 {
                color: #ffffff;
                text-align: center;
                margin-bottom: 25px;
                font-size: 1.8em;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                position: relative;
                z-index: 2;
            }

            .transfer-controls.unified {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                padding: 20px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 10px;
                border: 2px solid #3498db;
                position: relative;
                z-index: 2;
            }

            .transfer-controls.unified label {
                color: #ffffff;
                font-weight: bold;
                font-size: 14px;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
                min-width: auto;
            }

            .transfer-controls.unified select {
                padding: 10px 15px;
                border-radius: 8px;
                border: 2px solid #3498db;
                background: linear-gradient(135deg, #34495e, #2c3e50);
                color: #ffffff;
                font-weight: bold;
                font-size: 14px;
                min-width: 120px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .transfer-controls.unified select:hover {
                border-color: #e74c3c;
                box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            }

            .transfer-controls.unified select:focus {
                outline: none;
                border-color: #e74c3c;
                box-shadow: 0 0 15px rgba(231, 76, 60, 0.7);
            }

            .transfer-controls.unified button {
                padding: 12px 25px;
                border-radius: 8px;
                border: none;
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                color: #ffffff;
                font-weight: bold;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
                position: relative;
                overflow: hidden;
            }

            .transfer-controls.unified button::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s;
            }

            .transfer-controls.unified button:hover::before {
                left: 100%;
            }

            .transfer-controls.unified button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
                background: linear-gradient(135deg, #c0392b, #e74c3c);
            }

            .transfer-controls.unified button:active {
                transform: translateY(0);
                box-shadow: 0 2px 10px rgba(231, 76, 60, 0.4);
            }

            .transfer-controls.unified button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            /* SAME COLOR HIGHLIGHTING - Both source and target get blue highlight */
            .table-highlight-active {
                outline: 4px solid #3498db;
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.8);
                position: relative;
                z-index: 10;
                transform: scale(1.02);
                transition: all 0.3s ease;
            }

            .cell-highlight-active {
                background: rgba(52, 152, 219, 0.3) !important;
                color: #ffffff !important;
                font-weight: bold;
                transition: all 0.25s ease;
                border: 2px solid #3498db !important;
                box-shadow: inset 0 0 10px rgba(52, 152, 219, 0.5);
            }

            /* Transfer status indicator */
            .transfer-status {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: #ffffff;
                padding: 20px 40px;
                border-radius: 10px;
                border: 2px solid #3498db;
                font-size: 18px;
                font-weight: bold;
                z-index: 1000;
                display: none;
            }

            /* Preview Modal Styles */
            .preview-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            }

            .preview-content {
                background: #2c3e50;
                padding: 30px;
                border-radius: 15px;
                border: 3px solid #3498db;
                max-width: 800px;
                width: 90%;
                max-height: 80%;
                overflow-y: auto;
            }

            .preview-header {
                color: #3498db;
                text-align: center;
                margin-bottom: 25px;
                font-size: 24px;
                font-weight: bold;
            }

            .preview-comparison {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 25px;
            }

            .station-preview {
                background: #34495e;
                padding: 20px;
                border-radius: 10px;
                border: 2px solid #4a5c6a;
            }

            .station-preview h3 {
                color: #e74c3c;
                margin-bottom: 15px;
                text-align: center;
            }

            .metric-row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #4a5c6a;
                color: white;
            }

            .metric-row:last-child {
                border-bottom: none;
            }

            .preview-buttons {
                display: flex;
                justify-content: center;
                gap: 15px;
            }

            .preview-btn {
                padding: 12px 25px;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s ease;
            }

            .preview-btn.confirm {
                background: #e74c3c;
                color: white;
            }

            .preview-btn.confirm:hover {
                background: #c0392b;
            }

            .preview-btn.cancel {
                background: #95a5a6;
                color: white;
            }

            .preview-btn.cancel:hover {
                background: #7f8c8d;
            }

            /* Transaction History Styles */
            .transaction-panel {
                background: #2c3e50;
                padding: 20px;
                margin: 20px 0;
                border-radius: 10px;
                border: 2px solid #34495e;
            }

            .transaction-item {
                background: #34495e;
                padding: 15px;
                margin: 10px 0;
                border-radius: 8px;
                border-left: 4px solid #3498db;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .transaction-info {
                color: white;
                flex-grow: 1;
            }

            .transaction-actions {
                display: flex;
                gap: 10px;
            }

            .undo-btn {
                background: #f39c12;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
            }

            .undo-btn:hover {
                background: #e67e22;
            }

            .undo-btn:disabled {
                background: #95a5a6;
                cursor: not-allowed;
            }

            /* Optional: keep previous styles for compatibility */
            .transfer-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .transfer-group {
                background-color: #34495e;
                padding: 15px;
                border-radius: 5px;
                border: 1px solid #4a5c6a;
            }

            .transfer-group h4 {
                color: #3498db;
                margin: 0 0 10px 0;
                font-size: 14px;
                text-align: center;
            }

            .transfer-row {
                display: flex;
                align-items: center;
                gap: 6px;
                margin-bottom: 6px;
            }

            .transfer-row label {
                color: white;
                font-size: 12px;
                min-width: 20px;
            }

            .transfer-row select {
                flex: 1;
                padding: 5px;
                border-radius: 3px;
                border: 1px solid #555;
                background-color: #555;
                color: white;
            }

            .transfer-buttons {
                display: flex;
                justify-content: center;
                gap: 6px;
                flex-wrap: wrap;
                margin-top: 6px;
            }

            .transfer-btn {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.3s;
            }

            .transfer-btn:hover {
                background-color: #2980b9;
            }

            .transfer-btn.primary {
                background-color: #e74c3c;
                font-weight: bold;
                padding: 12px 20px;
            }

            .transfer-btn.primary:hover {
                background-color: #c0392b;
            }

            /* Centered action bar under the Hour block */
            #hour-actions {
                display: flex;
                justify-content: center;
                gap: 10px;
                flex-wrap: wrap;
                margin: 12px auto 0;
            }

            /* Keep buttons compact */
            #hour-actions button,
            #hour-actions .transfer-btn {
                height: 30px;
                padding: 6px 10px;
                font-size: 12px;
                line-height: 1;
            }
        </style>


        <!-- <button onclick="openPrintDialog()" class="center1" >PRINT</button>  -->


        <div class="table-container">
            <table id="North" class="display">
                <th id="North th" colspan="14">North Outbounds</th>
                <tr>
                    <th>&nbsp;</th>
                    <th colspan="3"> OB1 </th>
                    <th colspan="3"> OB2 </th>
                    <th colspan="2"> OB3 </th>
                    <th colspan="2"> OB4 </th>
                    <th colspan="2"> OB5 </th>
                    <th> Totals</th>
                <tr>
                    <td class="rowhead">Uptime %</td>
                    <td colspan="3" id="OB01_UTPct">&nbsp;</td>
                    <td colspan="3" id="OB02_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB03_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB04_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB05_UTPct">&nbsp;</td>
                    <td id="North_UTPct">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Chutefulls</td>
                    <td colspan="3" id="OB01_CF">&nbsp;</td>
                    <td colspan="3" id="OB02_CF">&nbsp;</td>
                    <td colspan="2" id="OB03_CF">&nbsp;</td>
                    <td colspan="2" id="OB04_CF">&nbsp;</td>
                    <td colspan="2" id="OB05_CF">&nbsp;</td>
                    <td id="North_CF">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Chutefull %</td>
                    <td colspan="3" id="OB01_CFPct">&nbsp;</td>
                    <td colspan="3" id="OB02_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB03_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB04_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB05_CFPct">&nbsp;</td>
                    <td id="North_CFPct">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Belt Stops</td>
                    <td colspan="3" id="OB01_BS">&nbsp;</td>
                    <td colspan="3" id="OB02_BS">&nbsp;</td>
                    <td colspan="2" id="OB03_BS">&nbsp;</td>
                    <td colspan="2" id="OB04_BS">&nbsp;</td>
                    <td colspan="2" id="OB05_BS">&nbsp;</td>
                    <td id="North_BS">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Volume</td>
                    <td colspan="3" id="OB01_Vol">&nbsp;</td>
                    <td colspan="3" id="OB02_Vol">&nbsp;</td>
                    <td colspan="2" id="OB03_Vol">&nbsp;</td>
                    <td colspan="2" id="OB04_Vol">&nbsp;</td>
                    <td colspan="2" id="OB05_Vol">&nbsp;</td>
                    <td id="North_Vol">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Decline %</td>
                    <td colspan="3" id="OB01_DecPct">&nbsp;</td>
                    <td colspan="3" id="OB02_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB03_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB04_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB05_DecPct">&nbsp;</td>
                    <td id="North_DecPct">&nbsp;</td>
                </tr>
                <tr style="background: rgba(255, 140, 0, 0.636);">
                    <th></th>
                    <th> S11 </th>
                    <th> S12 </th>
                    <th> S21 </th>
                    <th> S13 </th>
                    <th> S14 </th>
                    <th> S22 </th>
                    <th> S15 </th>
                    <th> S16 </th>
                    <th> S17 </th>
                    <th> S18 </th>
                    <th> S19 </th>
                    <th> S20 </th>
                </tr>
                <tr>
                    <td class="rowhead">Uptime %</td>
                    <td id="S11_UTPct">&nbsp;</td>
                    <td id="S12_UTPct">&nbsp;</td>
                    <td id="S21_UTPct">&nbsp;</td>
                    <td id="S13_UTPct">&nbsp;</td>
                    <td id="S14_UTPct">&nbsp;</td>
                    <td id="S22_UTPct">&nbsp;</td>
                    <td id="S15_UTPct">&nbsp;</td>
                    <td id="S16_UTPct">&nbsp;</td>
                    <td id="S17_UTPct">&nbsp;</td>
                    <td id="S18_UTPct">&nbsp;</td>
                    <td id="S19_UTPct">&nbsp;</td>
                    <td id="S20_UTPct">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Chutefulls</td>
                    <td id="S11_CF">&nbsp;</td>
                    <td id="S12_CF">&nbsp;</td>
                    <td id="S21_CF">&nbsp;</td>
                    <td id="S13_CF">&nbsp;</td>
                    <td id="S14_CF">&nbsp;</td>
                    <td id="S22_CF">&nbsp;</td>
                    <td id="S15_CF">&nbsp;</td>
                    <td id="S16_CF">&nbsp;</td>
                    <td id="S17_CF">&nbsp;</td>
                    <td id="S18_CF">&nbsp;</td>
                    <td id="S19_CF">&nbsp;</td>
                    <td id="S20_CF">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Chutefull %</td>
                    <td id="S11_CFPct">&nbsp;</td>
                    <td id="S12_CFPct">&nbsp;</td>
                    <td id="S21_CFPct">&nbsp;</td>
                    <td id="S13_CFPct">&nbsp;</td>
                    <td id="S14_CFPct">&nbsp;</td>
                    <td id="S22_CFPct">&nbsp;</td>
                    <td id="S15_CFPct">&nbsp;</td>
                    <td id="S16_CFPct">&nbsp;</td>
                    <td id="S17_CFPct">&nbsp;</td>
                    <td id="S18_CFPct">&nbsp;</td>
                    <td id="S19_CFPct">&nbsp;</td>
                    <td id="S20_CFPct">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Belt Stops</td>
                    <td id="S11_BS">&nbsp;</td>
                    <td id="S12_BS">&nbsp;</td>
                    <td id="S21_BS">&nbsp;</td>
                    <td id="S13_BS">&nbsp;</td>
                    <td id="S14_BS">&nbsp;</td>
                    <td id="S22_BS">&nbsp;</td>
                    <td id="S15_BS">&nbsp;</td>
                    <td id="S16_BS">&nbsp;</td>
                    <td id="S17_BS">&nbsp;</td>
                    <td id="S18_BS">&nbsp;</td>
                    <td id="S19_BS">&nbsp;</td>
                    <td id="S20_BS">&nbsp;</td>
                </tr>
                <tr class="volSwap">
                    <td class="rowhead">Volume</td>
                    <td id="S11_Vol" class="value">&nbsp;</td>
                    <td id="S12_Vol" class="value">&nbsp;</td>
                    <td id="S21_Vol" class="value">&nbsp;</td>
                    <td id="S13_Vol" class="value">&nbsp;</td>
                    <td id="S14_Vol" class="value">&nbsp;</td>
                    <td id="S22_Vol" class="value">&nbsp;</td>
                    <td id="S15_Vol" class="value">&nbsp;</td>
                    <td id="S16_Vol" class="value">&nbsp;</td>
                    <td id="S17_Vol" class="value">&nbsp;</td>
                    <td id="S18_Vol" class="value">&nbsp;</td>
                    <td id="S19_Vol" class="value">&nbsp;</td>
                    <td id="S20_Vol" class="value">&nbsp;</td>
                </tr>
                <tr>
                    <td class="rowhead">Decline %</td>
                    <td id="S11_DecPct">&nbsp;</td>
                    <td id="S12_DecPct">&nbsp;</td>
                    <td id="S21_DecPct">&nbsp;</td>
                    <td id="S13_DecPct">&nbsp;</td>
                    <td id="S14_DecPct">&nbsp;</td>
                    <td id="S22_DecPct">&nbsp;</td>
                    <td id="S15_DecPct">&nbsp;</td>
                    <td id="S16_DecPct">&nbsp;</td>
                    <td id="S17_DecPct">&nbsp;</td>
                    <td id="S18_DecPct">&nbsp;</td>
                    <td id="S19_DecPct">&nbsp;</td>
                    <td id="S20_DecPct">&nbsp;</td>
                </tr>
            </table>


            <div class="button-container">
                <!-- Buttons for selecting query criteria -->
                <button class="button" data-criteria="1" onclick="selectCriteria('1')">Hour 0.5</button>
                <button class="button" data-criteria="2" onclick="selectCriteria('2')">Hour 1.0</button>
                <button class="button" data-criteria="3" onclick="selectCriteria('3')">Hour 1.5</button>
                <button class="button" data-criteria="4" onclick="selectCriteria('4')">Hour 2.0</button>
                <button class="button" data-criteria="5" onclick="selectCriteria('5')">Hour 2.5</button>
                <button class="button" data-criteria="6" onclick="selectCriteria('6')">Hour 3.0</button>
                <button class="button" data-criteria="7" onclick="selectCriteria('7')">Hour 3.5</button>
                <button class="button" data-criteria="8" onclick="selectCriteria('8')">Hour 4.0</button>
                <button class="button" data-criteria="9" onclick="selectCriteria('9')">Hour 4.5</button>
                <button class="button" data-criteria="10" onclick="selectCriteria('10')">Hour 5.0</button>
                <button class="button" data-criteria="11" onclick="selectCriteria('11')">Hour 5.5</button>
                <button class="button" data-criteria="12" onclick="selectCriteria('12')">Hour 6.0</button>
                <button class="button active" data-criteria="99" onclick="selectCriteria('99')">Final</button>
            </div>

            <table id="South">
                <th id="South th" colspan="12">South Outbounds</th>
                <tr>
                    <th> Totals </th>
                    <th colspan="2"> OB6 </th>
                    <th colspan="2"> OB7 </th>
                    <th colspan="2"> OB8 </th>
                    <th colspan="2"> OB9 </th>
                    <th colspan="2"> OB10 </th>
                    <th></th>
                <tr>
                    <td id="South_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB06_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB07_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB08_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB09_UTPct">&nbsp;</td>
                    <td colspan="2" id="OB10_UTPct">&nbsp;</td>
                    <td class="rowhead">Uptime %</td>
                </tr>
                <tr>
                    <td id="South_CF">&nbsp;</td>
                    <td colspan="2" id="OB06_CF">&nbsp;</td>
                    <td colspan="2" id="OB07_CF">&nbsp;</td>
                    <td colspan="2" id="OB08_CF">&nbsp;</td>
                    <td colspan="2" id="OB09_CF">&nbsp;</td>
                    <td colspan="2" id="OB10_CF">&nbsp;</td>
                    <td class="rowhead">Chutefulls</td>
                </tr>
                <tr>
                    <td id="South_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB06_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB07_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB08_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB09_CFPct">&nbsp;</td>
                    <td colspan="2" id="OB10_CFPct">&nbsp;</td>
                    <td class="rowhead">Chutefull %</td>
                </tr>
                <tr>

                    <td id="South_BS">&nbsp;</td>
                    <td colspan="2" id="OB06_BS">&nbsp;</td>
                    <td colspan="2" id="OB07_BS">&nbsp;</td>
                    <td colspan="2" id="OB08_BS">&nbsp;</td>
                    <td colspan="2" id="OB09_BS">&nbsp;</td>
                    <td colspan="2" id="OB10_BS">&nbsp;</td>
                    <td class="rowhead">Belt Stops</td>
                </tr>
                <tr>
                    <td id="South_Vol">&nbsp;</td>
                    <td colspan="2" id="OB06_Vol">&nbsp;</td>
                    <td colspan="2" id="OB07_Vol">&nbsp;</td>
                    <td colspan="2" id="OB08_Vol">&nbsp;</td>
                    <td colspan="2" id="OB09_Vol">&nbsp;</td>
                    <td colspan="2" id="OB10_Vol">&nbsp;</td>
                    <td class="rowhead">Volume</td>
                </tr>
                <tr>
                    <td id="South_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB06_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB07_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB08_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB09_DecPct">&nbsp;</td>
                    <td colspan="2" id="OB10_DecPct">&nbsp;</td>
                    <td class="rowhead">Decline %</td>
                </tr>
                <tr style="background: steelblue">
                    <th style="border: none; background:black;"></th>
                    <th> S1 </th>
                    <th> S2 </th>
                    <th> S3 </th>
                    <th> S4 </th>
                    <th> S5 </th>
                    <th> S6 </th>
                    <th> S7 </th>
                    <th> S8 </th>
                    <th> S9 </th>
                    <th> S10 </th>
                    <th></th>
                </tr>
                <tr>
                    <td style="border: none; background: black"></td>
                    <td id="S01_UTPct">&nbsp;</td>
                    <td id="S02_UTPct">&nbsp;</td>
                    <td id="S03_UTPct">&nbsp;</td>
                    <td id="S04_UTPct">&nbsp;</td>
                    <td id="S05_UTPct">&nbsp;</td>
                    <td id="S06_UTPct">&nbsp;</td>
                    <td id="S07_UTPct">&nbsp;</td>
                    <td id="S08_UTPct">&nbsp;</td>
                    <td id="S09_UTPct">&nbsp;</td>
                    <td id="S10_UTPct">&nbsp;</td>
                    <td class="rowhead">Uptime %</td>
                </tr>
                <tr>
                    <td style="border: none; background: black"></td>
                    <td id="S01_CF">&nbsp;</td>
                    <td id="S02_CF">&nbsp;</td>
                    <td id="S03_CF">&nbsp;</td>
                    <td id="S04_CF">&nbsp;</td>
                    <td id="S05_CF">&nbsp;</td>
                    <td id="S06_CF">&nbsp;</td>
                    <td id="S07_CF">&nbsp;</td>
                    <td id="S08_CF">&nbsp;</td>
                    <td id="S09_CF">&nbsp;</td>
                    <td id="S10_CF">&nbsp;</td>
                    <td class="rowhead">Chutefulls</td>
                </tr>
                <tr>
                    <td style="border: none; background: black"></td>
                    <td id="S01_CFPct">&nbsp;</td>
                    <td id="S02_CFPct">&nbsp;</td>
                    <td id="S03_CFPct">&nbsp;</td>
                    <td id="S04_CFPct">&nbsp;</td>
                    <td id="S05_CFPct">&nbsp;</td>
                    <td id="S06_CFPct">&nbsp;</td>
                    <td id="S07_CFPct">&nbsp;</td>
                    <td id="S08_CFPct">&nbsp;</td>
                    <td id="S09_CFPct">&nbsp;</td>
                    <td id="S10_CFPct">&nbsp;</td>
                    <td class="rowhead">Chutefull %</td>
                </tr>
                <tr>
                    <td style="border: none; background: black"></td>
                    <td id="S01_BS">&nbsp;</td>
                    <td id="S02_BS">&nbsp;</td>
                    <td id="S03_BS">&nbsp;</td>
                    <td id="S04_BS">&nbsp;</td>
                    <td id="S05_BS">&nbsp;</td>
                    <td id="S06_BS">&nbsp;</td>
                    <td id="S07_BS">&nbsp;</td>
                    <td id="S08_BS">&nbsp;</td>
                    <td id="S09_BS">&nbsp;</td>
                    <td id="S10_BS">&nbsp;</td>
                    <td class="rowhead">Belt Stops</td>
                </tr>
                <tr class="volSwap">
                    <td style="border: none; background: black"></td>
                    <td id="S01_Vol" class="value">&nbsp;</td>
                    <td id="S02_Vol" class="value">&nbsp;</td>
                    <td id="S03_Vol" class="value">&nbsp;</td>
                    <td id="S04_Vol" class="value">&nbsp;</td>
                    <td id="S05_Vol" class="value">&nbsp;</td>
                    <td id="S06_Vol" class="value">&nbsp;</td>
                    <td id="S07_Vol" class="value">&nbsp;</td>
                    <td id="S08_Vol" class="value">&nbsp;</td>
                    <td id="S09_Vol" class="value">&nbsp;</td>
                    <td id="S10_Vol" class="value">&nbsp;</td>
                    <td class="rowhead">Volume</td>
                </tr>
                <tr>
                    <td style="border: none; background: black"></td>
                    <td id="S01_DecPct">&nbsp;</td>
                    <td id="S02_DecPct">&nbsp;</td>
                    <td id="S03_DecPct">&nbsp;</td>
                    <td id="S04_DecPct">&nbsp;</td>
                    <td id="S05_DecPct">&nbsp;</td>
                    <td id="S06_DecPct">&nbsp;</td>
                    <td id="S07_DecPct">&nbsp;</td>
                    <td id="S08_DecPct">&nbsp;</td>
                    <td id="S09_DecPct">&nbsp;</td>
                    <td id="S10_DecPct">&nbsp;</td>
                    <td class="rowhead">Decline %</td>
                </tr>

                <style>
                    .shine {
                        position: relative;
                    }

                    .shine::after {
                        content: "";
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: repeating-linear-gradient(120deg, transparent, rgba(130, 8, 186, 0.5), rgba(8, 186, 118, 0.5), rgba(130, 8, 186, 0.5), transparent);
                        animation: shine 2s infinite;
                    }

                    @keyframes shine {
                        0% {
                            left: -155%;

                        }

                        100% {
                            left: 155%;

                        }
                    }

                    .button2 {
                        margin-top: 3px;
                        width: 80px;
                        cursor: pointer;
                        display: grid;
                        position: relative;
                        justify-content: space-between;
                        width: 80px;
                        margin-top: 3px;
                        /*  justify-content: flex-start;  */

                    }

                    .button3 {
                        cursor: pointer;
                        display: inline-block;
                        position: relative;
                        justify-content: flex;
                        width: 80px;
                        margin-top: 3px;
                        margin-left: auto;
                        margin-right: auto;
                        /*  justify-content: flex-start;  */

                    }


                    /* Test Style for Dropdown  */
                    .dropdown {
                        position: relative;
                        display: inline-block;
                    }

                    .dropdown-btn {
                        padding: 5px 5px;
                        cursor: pointer;
                    }

                    .dropdown-content {
                        display: none;
                        position: absolute;
                        background-color: #f9f9f9;
                        min-width: 160px;
                        max-height: 150px;
                        /* Limit height */
                        overflow-y: auto;
                        /* Enable vertical scrolling */
                        box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
                        z-index: 1;
                    }

                    .dropdown-content a {
                        color: black;
                        padding: 8px 12px;
                        text-decoration: none;
                        display: block;
                    }

                    .dropdown-content a:hover {
                        background-color: #f1f1f1;
                    }
                </style>

            </table>

        </div>

        <!-- ENHANCED TRANSFER SECTION WITH SAME COLOR HIGHLIGHTING -->
        <div class="transfer-section">
            <h3>ðŸ”„ Enhanced Station Data Transfer</h3>

            <div class="transfer-controls unified">
                <div class="transfer-row" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                    <label for="masterSource">Source Station:</label>
                    <select id="masterSource">
                        <option value="S01">S1</option>
                        <option value="S02">S2</option>
                        <option value="S03">S3</option>
                        <option value="S04">S4</option>
                        <option value="S05">S5</option>
                        <option value="S06">S6</option>
                        <option value="S07">S7</option>
                        <option value="S08">S8</option>
                        <option value="S09">S9</option>
                        <option value="S10">S10</option>
                        <option value="S11">S11</option>
                        <option value="S12">S12</option>
                        <option value="S13">S13</option>
                        <option value="S14">S14</option>
                        <option value="S15">S15</option>
                        <option value="S16">S16</option>
                        <option value="S17">S17</option>
                        <option value="S18">S18</option>
                        <option value="S19">S19</option>
                        <option value="S20">S20</option>
                        <option value="S21">S21</option>
                        <option value="S22">S22</option>
                    </select>

                    <label for="masterTarget">Target Station:</label>
                    <select id="masterTarget">
                        <option value="S01">S1</option>
                        <option value="S02">S2</option>
                        <option value="S03">S3</option>
                        <option value="S04">S4</option>
                        <option value="S05">S5</option>
                        <option value="S06">S6</option>
                        <option value="S07">S7</option>
                        <option value="S08">S8</option>
                        <option value="S09">S9</option>
                        <option value="S10">S10</option>
                        <option value="S11">S11</option>
                        <option value="S12">S12</option>
                        <option value="S13">S13</option>
                        <option value="S14">S14</option>
                        <option value="S15">S15</option>
                        <option value="S16">S16</option>
                        <option value="S17">S17</option>
                        <option value="S18">S18</option>
                        <option value="S19">S19</option>
                        <option value="S20">S20</option>
                        <option value="S21">S21</option>
                        <option value="S22">S22</option>
                    </select>

                    <button id="transferBtn" onclick="handleEnhancedTransfer()">ðŸ”„ PREVIEW & SWAP DATA</button>
                    <button onclick="toggleTransactionPanel()" style="background: #f39c12; padding: 12px 20px; border: none; border-radius: 8px; color: white; font-weight: bold; margin-left: 10px; cursor: pointer;">
                        ðŸ“‹ History
                    </button>
                </div>
            </div>
        </div>

        <!-- SWAP MANAGEMENT CONTROLS -->
        <div class="transfer-section" style="margin-top: 15px;">
            <h3>ðŸ”§ Swap Management & Status</h3>

            <div class="transfer-controls unified">
                <div class="transfer-row" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;">

                    <!-- Active Swaps Display -->
                    <div id="activeSwapsDisplay" style="background: rgba(52, 152, 219, 0.1); padding: 10px 15px; border-radius: 8px; border: 2px solid #3498db; min-width: 200px;">
                        <strong style="color: #3498db;">Active Swaps:</strong>
                        <div id="swapsList" style="color: white; margin-top: 5px; font-size: 14px;">
                            No active swaps
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <button onclick="clearAllSwaps()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                        ðŸ—‘ï¸ Clear All Swaps
                    </button>

                    <button onclick="refreshSwapDisplay()" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                        ðŸ”„ Refresh Status
                    </button>

                    <button onclick="showSwapDebugInfo()" style="background: linear-gradient(135deg, #8e44ad, #732d91); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                        ðŸ› Debug Info
                    </button>

                </div>

                <!-- Swap Status Information -->
                <div id="swapStatusInfo" style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; color: #bdc3c7; font-size: 14px; text-align: center;">
                    Swaps will persist across hour changes and auto-refresh cycles
                </div>
            </div>
        </div>

        <!-- Transfer Status Indicator -->
        <div id="transferStatus" class="transfer-status">
            Transferring data...
        </div>

        <!-- New edits | 10/8/24 | W.Rodriguez -->
        <div class="table-container">
            <h1></h1>
            <table id="Exceptions" class="center" style="width:70%; margin-left: auto; margin-right: auto;">
                <th id="Exceptions th" colspan="14">Uptime %</th>
                <tr>
                    <td>RC01</td>
                    <td id="RC01_UTPct" class="rowhead"></td>
                    <td>RC02</td>
                    <td id="RC02_UTPct" class="rowhead"></td>
                    <td>RC03</td>
                    <td id="RC03_UTPct" class="rowhead"></td>
                    <td>RC04</td>
                    <td id="RC04_UTPct" class="rowhead"></td>
                    <td>IR1-F1</td>
                    <td id="IR1_F1_UTPct" class="rowhead"></td>
                    <td>IR1-F2</td>
                    <td id="IR1_F2_UTPct" class="rowhead"></td>
                    <td>IR2-F1</td>
                    <td id="IR2_F1_UTPct" class="rowhead"></td>
                </tr>
                <tr>
                    <td>IR2-F2</td>
                    <td id="IR2_F2_UTPct" class="rowhead"></td>
                    <td>IR2-D6</td>
                    <td id="IR2_D06_UTPct" class="rowhead"></td>
                    <td>IR2-D7</td>
                    <td id="IR2_D07_UTPct" class="rowhead"></td>
                    <td>IR2-D8</td>
                    <td id="IR2_D08_UTPct" class="rowhead"></td>
                    <td>IR2-D9</td>
                    <td id="IR2_D09_UTPct" class="rowhead"></td>
                    <td>IR2-10</td>
                    <td id="IR2_D10_UTPct" class="rowhead"></td>
                    <td>IR1-D1</td>
                    <td id="IR1_D01_UTPct" class="rowhead"></td>
                </tr>
                <tr>
                    <td>IR1-D2</td>
                    <td id="IR1_D02_UTPct" class="rowhead"></td>
                    <td>IR1-D3</td>
                    <td id="IR1_D03_UTPct" class="rowhead"></td>
                    <td>IR1-D4</td>
                    <td id="IR1_D04_UTPct" class="rowhead"></td>
                    <td>IR1-D5</td>
                    <td id="IR1_D05_UTPct" class="rowhead"></td>
                    <td>DA1C</td>
                    <td id="DA1C_UTPct" class="rowhead"></td>
                    <td></td>
                    <td id="DA02C_UTPct" class="rowhead"></td>
                    <td>DA2S</td>
                    <td id="DA02_UTPct" class="rowhead"></td>
                </tr>

            </table>
        </div>

        <script>

            $(document).ready(function () {

                $('#dt').text(GetNow())

                $.getJSON('SortDateServer.aspx', function (data) {

                    //populates sort drop down list with the last 4 sort dates
                    console.log('ðŸ“… Sort data received from server:', data);
                    console.log('ðŸ“Š Number of sorts returned:', Array.isArray(data) ? data.length : Object.keys(data).length);

                    $('#sortSel')
                        .find('option')
                        .remove()
                        .end();


                    for (var i in data) {
                        var sortID = data[i].id;
                        var sortDate = data[i].SortDate;
                        var sortType = data[i].SortType;

                        console.log(`  Sort ${i}: ID=${sortID}, Date=${sortDate}, Type=${sortType}`);

                        $('#sortSel').append($('<option>', {
                            value: sortID,
                            text: sortDate + ' - ' + sortType
                        }));


                        //load the current entry values
                        if (i == 0) {
                            loadCurrentValues(sortID)
                        }
                    }

                    console.log(`âœ… Added ${$('#sortSel option').length} sort options to dropdown`);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('âŒ Failed to load sort dates:', textStatus, errorThrown);
                    console.error('Response:', jqXHR.responseText);
                });


                $("#sortSel").change(function () {
                    //console.log("Sort selection changed: " + $("#sortSel").val());
                    loadCurrentValues($("#sortSel").val())
                });


                function loadCurrentValues(sortID) {
                    // SWAP PERSISTENCE: Preserve swap state before data load
                    const preservedStations = swapInterceptor.beforeDataLoad();

                    //Load the hourly values
                    $.ajax({
                        url: "HourlyQuicklookServer_BLDG.aspx?sortid=" + sortID,
                        success: function (data) {

                            //Clear the table from current values
                            $('#HourlyTable tr').each(function (index) {

                                if (index > 0) {
                                    $.each(this.cells, function (index) {
                                        if (index > 0) {
                                            $(this).text("");
                                        }

                                    });

                                }
                            });

                            // console.log(data);

                            for (var i = 0; i < data.length; i++) {

                                try {
                                    $("#" + data[i].hourNumber + "_TS").text(data[i].TS)
                                    $("#" + data[i].hourNumber + "_BUILDVol").text(data[i].Building_Total_InputVolume.toLocaleString())
                                    $("#" + data[i].hourNumber + "_PriVol").text(data[i].Primary_Total_InputVolume.toLocaleString())
                                    $("#" + data[i].hourNumber + "_ExVol").text(data[i].Exceptions_Total_InputVolume.toLocaleString())
                                    $("#" + data[i].hourNumber + "_OBVol").text(data[i].Outbound_Total_InputVolume.toLocaleString())
                                    $("#" + data[i].hourNumber + "_BFVol").text(data[i].Bullfrog_Total_InputVolume.toLocaleString())
                                    $("#" + data[i].hourNumber + "_BFVolPct").text(data[i].Percent_Smalls.toLocaleString() + ' %')
                                    $("#" + data[i].hourNumber + "_CF").text(data[i].Outbound_Chutefull_Total.toLocaleString())
                                    $("#" + data[i].hourNumber + "_BS").text(data[i].BeltStops_Total.toLocaleString())
                                    $("#" + data[i].hourNumber + "_DEFPct").text(data[i].Defects_Percent.toLocaleString() + ' %')
                                    $("#" + data[i].hourNumber + "_PNRPct").text(data[i].Primary_Total_NoReadsPct.toLocaleString() + ' %') // $("#" + data[i].hourNumber + "_PNRPct").text(data[i].Primary_NoReads_Total.toLocaleString() + ' %')

                                } catch (err) {

                                }

                            }

                            // Mark building data as loaded
                            dataLoadState.markLoaded('building');

                            // SWAP PERSISTENCE: Queue restoration instead of direct call
                            swapRestorationQueue.add('building-data-refresh');

                        }

                    });

                }

                setInterval(function () {
                    $('#dt').text(GetNow())
                    loadCurrentValues($("#sortSel").val())
                }, 10000);

                // Initial load of outbound values with default criteria
                selectCriteria(criteria);


            });

            // ==========================================
            // CROSS-TAB SYNC INITIALIZATION
            // ==========================================

            // Initialize cross-tab synchronization listener with enhanced queue system
            crossTabSwapSync.initListener((trigger) => {
                console.log(`ðŸ“¡ Cross-tab event received from ${trigger.tabId}: ${trigger.operation}`);

                // Reload swap state from localStorage
                const newSwapState = crossTabSwapSync.loadSwapState();
                swapStateManager.activeSwaps = newSwapState;

                // Handle different operation types
                if (trigger.operation === 'clear') {
                    console.log('ðŸ—‘ï¸ Clearing swaps based on cross-tab event');
                    refreshSwapDisplay();
                } else {
                    // Queue swap restoration with retry mechanism
                    console.log('ðŸ“¥ Queueing swap restoration from cross-tab event');
                    swapRestorationQueue.add('cross-tab-sync');
                }
            });

            // Load initial swap state from localStorage on page load
            // Using the queue system with proper data load waiting
            setTimeout(() => {
                const savedSwaps = crossTabSwapSync.loadSwapState();
                if (savedSwaps.size > 0) {
                    console.log(`ðŸ’¾ Found ${savedSwaps.size / 2} saved swap(s) on page load`);
                    swapStateManager.activeSwaps = savedSwaps;

                    // Queue restoration - will execute when data is ready
                    swapRestorationQueue.add('page-load');
                } else {
                    console.log('ðŸ“­ No saved swaps found on page load');
                }
            }, 500);

            // ==========================================
            // ENHANCED TRANSFER FUNCTIONALITY
            // ==========================================

            // metrics list with transfer modes
            // Enhanced metrics configuration for atomic swapping
            const METRICS = [
                { key: "Vol", type: "int", mode: "swap", label: "Volume" },
                { key: "BS", type: "int", mode: "swap", label: "Belt Stops" },
                { key: "CF", type: "int", mode: "swap", label: "Chutefulls" },
                { key: "UTPct", type: "percent", mode: "swap", label: "Uptime %" },
                { key: "DecPct", type: "percent", mode: "swap", label: "Decline %" },
                { key: "CFPct", type: "percent", mode: "swap", label: "Chutefull %" },
            ];

            // ==========================================
            // DATA LOAD STATE TRACKER
            // ==========================================

            const dataLoadState = {
                building: false,
                outbound: false,
                exceptions: false,
                smalls: false,
                irreg: false,
                primary: false,
                pendingSwapRestoration: false,
                loadStartTime: null,

                // Mark a data type as loaded
                markLoaded(dataType) {
                    if (this.hasOwnProperty(dataType) && typeof this[dataType] === 'boolean') {
                        this[dataType] = true;
                        console.log(`âœ… Data loaded: ${dataType}`, this.getSummary());

                        // Check if all data is loaded and trigger pending swap restoration
                        if (this.isAllDataLoaded() && this.pendingSwapRestoration) {
                            console.log('ðŸ”„ All data loaded - executing pending swap restoration');
                            this.pendingSwapRestoration = false;
                            setTimeout(() => {
                                swapRestorationQueue.executeQueue();
                            }, 50);
                        }
                    }
                },

                // Reset all load states
                reset() {
                    this.building = false;
                    this.outbound = false;
                    this.exceptions = false;
                    this.smalls = false;
                    this.irreg = false;
                    this.primary = false;
                    this.loadStartTime = Date.now();
                    console.log('ðŸ”„ Data load state reset');
                },

                // Check if all data types are loaded
                isAllDataLoaded() {
                    return this.building && this.outbound && this.exceptions &&
                           this.smalls && this.irreg && this.primary;
                },

                // Get summary of load state
                getSummary() {
                    return {
                        building: this.building,
                        outbound: this.outbound,
                        exceptions: this.exceptions,
                        smalls: this.smalls,
                        irreg: this.irreg,
                        primary: this.primary,
                        allLoaded: this.isAllDataLoaded(),
                        elapsedMs: this.loadStartTime ? Date.now() - this.loadStartTime : 0
                    };
                },

                // Wait for all data to be loaded with timeout
                waitForAllData(callback, timeoutMs = 5000) {
                    const startTime = Date.now();
                    const checkInterval = setInterval(() => {
                        if (this.isAllDataLoaded()) {
                            clearInterval(checkInterval);
                            console.log('âœ… All data loaded, executing callback');
                            callback();
                        } else if (Date.now() - startTime > timeoutMs) {
                            clearInterval(checkInterval);
                            console.warn('âš ï¸ Timeout waiting for data, executing callback anyway', this.getSummary());
                            callback();
                        }
                    }, 50);
                }
            };

            // Transaction history for data preservation
            let transactionHistory = [];
            const MAX_HISTORY_SIZE = 10;

            // ==========================================
            // SWAP RESTORATION QUEUE WITH RETRY
            // ==========================================

            const swapRestorationQueue = {
                queue: [],
                isProcessing: false,
                maxRetries: 3,

                // Add swap restoration to queue
                add(reason = 'manual') {
                    const task = {
                        reason: reason,
                        timestamp: Date.now(),
                        retries: 0
                    };
                    this.queue.push(task);
                    console.log(`ðŸ“¥ Queued swap restoration (${reason}), queue size: ${this.queue.length}`);

                    // Auto-execute if data is already loaded
                    if (dataLoadState.isAllDataLoaded() && !this.isProcessing) {
                        this.executeQueue();
                    } else {
                        dataLoadState.pendingSwapRestoration = true;
                        console.log('â³ Waiting for data to load before restoration...');
                    }
                },

                // Execute all queued restorations
                executeQueue() {
                    if (this.isProcessing) {
                        console.log('â³ Already processing queue, skipping...');
                        return;
                    }

                    if (this.queue.length === 0) {
                        console.log('ðŸ“­ Queue is empty, nothing to restore');
                        return;
                    }

                    this.isProcessing = true;
                    const task = this.queue.shift();

                    console.log(`ðŸ”„ Executing swap restoration (${task.reason}), retry ${task.retries}/${this.maxRetries}`);

                    try {
                        // Check if data is ready
                        if (!dataLoadState.isAllDataLoaded()) {
                            console.warn('âš ï¸ Data not fully loaded, requeueing...');
                            task.retries++;
                            if (task.retries < this.maxRetries) {
                                this.queue.unshift(task); // Put back at front
                                this.isProcessing = false;
                                // Retry after delay
                                setTimeout(() => this.executeQueue(), 500);
                            } else {
                                console.error('âŒ Max retries reached, forcing restoration anyway');
                                this.performRestoration(task);
                            }
                            return;
                        }

                        // Execute restoration
                        this.performRestoration(task);

                        // Continue with next in queue
                        this.isProcessing = false;
                        if (this.queue.length > 0) {
                            setTimeout(() => this.executeQueue(), 100);
                        }

                    } catch (error) {
                        console.error('âŒ Swap restoration failed:', error);
                        task.retries++;
                        if (task.retries < this.maxRetries) {
                            this.queue.unshift(task);
                            setTimeout(() => {
                                this.isProcessing = false;
                                this.executeQueue();
                            }, 500);
                        } else {
                            this.isProcessing = false;
                            console.error('âŒ Max retries reached, abandoning restoration');
                        }
                    }
                },

                // Perform the actual swap restoration
                performRestoration(task) {
                    console.log(`ðŸ”„ Restoring swaps (${task.reason})...`);
                    swapInterceptor.restoreSwapsByCurrentState();
                    refreshSwapDisplay();
                    console.log('âœ… Swap restoration completed successfully');
                },

                // Clear the queue
                clear() {
                    this.queue = [];
                    this.isProcessing = false;
                    console.log('ðŸ—‘ï¸ Swap restoration queue cleared');
                }
            };

            // ==========================================
            // SWAP STATE MANAGER FOR PERSISTENCE
            // ==========================================

            /*
             * KEY FIX EXPLANATION:
             *
             * PROBLEM: When hour changes (e.g., 1:00 â†’ 1:30), swaps were storing OLD data
             *
             * OLD APPROACH (BROKEN):
             * 1. Hour 1:00 - Swap S01â†”S02, cache their values
             * 2. Hour 1:30 - Server sends NEW data
             * 3. Restore function used CACHED values from Hour 1:00 âŒ
             *
             * NEW APPROACH (FIXED):
             * 1. Hour 1:00 - Swap S01â†”S02, only remember WHICH stations are swapped
             * 2. Hour 1:30 - Server sends NEW data to DOM
             * 3. Read NEW data from DOM and swap it according to mapping âœ“
             *
             * This ensures swaps always operate on fresh server data!
             */

            // Global swap state tracking - FIXED VERSION
            let swapStateManager = {
                activeSwaps: new Map(), // station -> partner station (bidirectional mapping)

                // Initialize or reset swap state
                init() {
                    this.activeSwaps.clear();

                    // Load existing swaps from localStorage on init
                    const savedSwaps = crossTabSwapSync.loadSwapState();
                    this.activeSwaps = savedSwaps;

                    console.log('SwapStateManager initialized with saved swaps:', Array.from(this.activeSwaps.entries()));
                },

                // Register a swap between two stations
                registerSwap(stationA, stationB) {
                    console.log(`Registering swap: ${stationA} â†” ${stationB}`);

                    // Store bidirectional mapping
                    this.activeSwaps.set(stationA, stationB);
                    this.activeSwaps.set(stationB, stationA);

                    // Save to localStorage to sync with other tabs
                    crossTabSwapSync.saveSwapState(this.activeSwaps);

                    console.log('Active swaps:', Array.from(this.activeSwaps.entries()));
                },

                // Get the partner station that this station is swapped with
                getSwapPartner(station) {
                    return this.activeSwaps.get(station);
                },

                // Check if a station is involved in any swaps
                isSwapped(station) {
                    return this.activeSwaps.has(station);
                },

                // Get all stations involved in swaps
                getAllSwappedStations() {
                    return Array.from(this.activeSwaps.keys());
                },

                // Clear specific swap
                clearSwap(station) {
                    const partner = this.activeSwaps.get(station);
                    if (partner) {
                        this.activeSwaps.delete(station);
                        this.activeSwaps.delete(partner);
                        console.log(`Cleared swap between ${station} and ${partner}`);
                    }
                },

                // Clear all swaps
                clearAllSwaps() {
                    const swappedStations = this.getAllSwappedStations();
                    this.activeSwaps.clear();

                    // Clear from localStorage to sync with other tabs
                    crossTabSwapSync.clearSwapState();

                    console.log('Cleared all swaps');
                    return swappedStations;
                },

                // Get swap status summary for UI
                getSwapSummary() {
                    const swaps = [];
                    const processed = new Set();

                    this.activeSwaps.forEach((target, source) => {
                        if (!processed.has(source) && !processed.has(target)) {
                            swaps.push({ source, target });
                            processed.add(source);
                            processed.add(target);
                        }
                    });

                    return swaps;
                }
            };

            // Initialize the swap state manager
            swapStateManager.init();

            // ==========================================
            // CROSS-TAB SYNCHRONIZATION SYSTEM
            // ==========================================

            const crossTabSwapSync = {
                STORAGE_KEY: 'dashboard_active_swaps',
                TRIGGER_KEY: 'swap_update_trigger',
                METADATA_KEY: 'swap_metadata',
                TAB_ID: 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),

                // Save swap state to localStorage with metadata
                saveSwapState(swapMap, operationType = 'swap') {
                    const swapArray = Array.from(swapMap.entries());

                    // Save swap data
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(swapArray));

                    // Save metadata
                    const metadata = {
                        timestamp: Date.now(),
                        tabId: this.TAB_ID,
                        operation: operationType,
                        swapCount: swapMap.size / 2, // Divided by 2 because bidirectional
                        version: 1
                    };
                    localStorage.setItem(this.METADATA_KEY, JSON.stringify(metadata));

                    // Trigger storage event for other tabs
                    const trigger = {
                        timestamp: Date.now(),
                        tabId: this.TAB_ID,
                        operation: operationType
                    };
                    localStorage.setItem(this.TRIGGER_KEY, JSON.stringify(trigger));

                    console.log(`ðŸ’¾ Saved swap state (${operationType}) from tab ${this.TAB_ID}:`, swapArray);
                },

                // Load swap state from localStorage
                loadSwapState() {
                    const stored = localStorage.getItem(this.STORAGE_KEY);
                    if (!stored) return new Map();

                    try {
                        const swapArray = JSON.parse(stored);
                        const metadata = this.loadMetadata();
                        console.log('ðŸ“‚ Loaded swap state from localStorage:', {
                            swaps: swapArray,
                            metadata: metadata
                        });
                        return new Map(swapArray);
                    } catch (e) {
                        console.error('âŒ Failed to parse swap state:', e);
                        return new Map();
                    }
                },

                // Load metadata
                loadMetadata() {
                    const stored = localStorage.getItem(this.METADATA_KEY);
                    if (!stored) return null;

                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        console.error('âŒ Failed to parse swap metadata:', e);
                        return null;
                    }
                },

                // Clear swap state from localStorage
                clearSwapState() {
                    localStorage.removeItem(this.STORAGE_KEY);
                    localStorage.removeItem(this.METADATA_KEY);

                    const trigger = {
                        timestamp: Date.now(),
                        tabId: this.TAB_ID,
                        operation: 'clear'
                    };
                    localStorage.setItem(this.TRIGGER_KEY, JSON.stringify(trigger));
                    console.log(`ðŸ—‘ï¸ Cleared swap state from tab ${this.TAB_ID}`);
                },

                // Listen for changes from other tabs
                initListener(callback) {
                    window.addEventListener('storage', (e) => {
                        if (e.key === this.TRIGGER_KEY) {
                            try {
                                const trigger = JSON.parse(e.newValue || '{}');

                                // Ignore events from this tab
                                if (trigger.tabId === this.TAB_ID) {
                                    console.log('ðŸ”‡ Ignoring storage event from same tab');
                                    return;
                                }

                                console.log(`ðŸ“¡ Storage event from tab ${trigger.tabId} (${trigger.operation})`);
                                callback(trigger);
                            } catch (err) {
                                console.error('âŒ Failed to parse trigger:', err);
                            }
                        }
                    });
                    console.log(`ðŸ‘‚ Cross-tab sync listener initialized for tab ${this.TAB_ID}`);
                }
            };

            // ==========================================
            // DATA LOAD INTERCEPTOR FOR SWAP PERSISTENCE
            // ==========================================

            // Swap restoration functions - FIXED VERSION
            const swapInterceptor = {
                // Store current swap state before data load
                beforeDataLoad() {
                    console.log('Preserving swap state before data load...');
                    // Just return the list of swapped stations so we know what to process
                    return swapStateManager.getAllSwappedStations();
                },

                // Restore swap state after data load - THIS IS THE KEY FIX
                restoreSwapsByCurrentState() {
                    console.log('Restoring swaps using FRESH server data...');

                    const swapSummary = swapStateManager.getSwapSummary();
                    if (swapSummary.length === 0) {
                        console.log('No active swaps to restore');
                        return;
                    }

                    // For each swap pair, swap the FRESH data that just came from the server
                    swapSummary.forEach(swap => {
                        console.log(`Applying swap: ${swap.source} â†” ${swap.target} to fresh data`);
                        this.swapFreshData(swap.source, swap.target);
                    });

                    console.log('Swap restoration completed using fresh server data');
                },

                // Swap fresh data between two stations (data that just loaded from server)
                swapFreshData(stationA, stationB) {
                    // CRITICAL: We read the CURRENT values in the DOM (fresh from server)
                    // and then swap them. This ensures we're always working with the latest data.

                    // Step 1: Read fresh values from both stations
                    const freshDataA = {};
                    const freshDataB = {};

                    METRICS.forEach(metric => {
                        const cellA = document.getElementById(`${stationA}_${metric.key}`);
                        const cellB = document.getElementById(`${stationB}_${metric.key}`);

                        if (cellA && cellB) {
                            freshDataA[metric.key] = readCellValue(cellA, metric.type);
                            freshDataB[metric.key] = readCellValue(cellB, metric.type);
                        }
                    });

                    // Step 2: Write swapped values (A's fresh data goes to B, B's fresh data goes to A)
                    METRICS.forEach(metric => {
                        const cellA = document.getElementById(`${stationA}_${metric.key}`);
                        const cellB = document.getElementById(`${stationB}_${metric.key}`);

                        if (cellA && cellB) {
                            // Station A gets Station B's fresh data
                            writeCellValue(cellA, freshDataB[metric.key], metric.type);
                            // Station B gets Station A's fresh data
                            writeCellValue(cellB, freshDataA[metric.key], metric.type);
                        }
                    });

                    console.log(`Swapped fresh data: ${stationA} â†” ${stationB}`);
                }
            };

            // Enhanced cell value reading
            function readCellValue(cell, type) {
                const txt = cell.textContent.replace(/\u00A0/g, "").trim();
                if (txt === "" || txt === "&nbsp;") return 0;
                if (type === "percent") {
                    const m = txt.match(/-?\d*\.?\d+/);
                    if (!m) return null;
                    const n = parseFloat(m[0]);
                    return Number.isNaN(n) ? null : n;
                }
                if (type === "float") {
                    const n = parseFloat(txt.replace(/,/g, ""));
                    return Number.isNaN(n) ? null : n;
                }
                const n = parseInt(txt.replace(/,/g, ""), 10);
                return Number.isNaN(n) ? null : n;
            }

            // Enhanced cell value writing
            function writeCellValue(cell, value, type) {
                if (value === 0) {
                    cell.innerHTML = "&nbsp;";
                    return;
                }
                if (type === "percent") {
                    cell.textContent = `${value}%`;
                    return;
                }
                if (type === "float") {
                    cell.textContent = Number(value).toLocaleString(undefined, { maximumFractionDigits: 2 });
                    return;
                }
                cell.textContent = parseInt(value, 10).toLocaleString();
            }

            // ==========================================
            // DATA PRESERVATION & BACKUP SYSTEM
            // ==========================================

            function createStateBackup(stations) {
                const backup = {};
                stations.forEach(station => {
                    backup[station] = {};
                    METRICS.forEach(metric => {
                        const cellId = `${station}_${metric.key}`;
                        const cell = document.getElementById(cellId);
                        if (cell) {
                            backup[station][metric.key] = {
                                cellId: cellId,
                                value: readCellValue(cell, metric.type),
                                displayValue: cell.textContent
                            };
                        }
                    });
                });
                return backup;
            }

            function addToTransactionHistory(transaction) {
                transactionHistory.unshift(transaction);
                if (transactionHistory.length > MAX_HISTORY_SIZE) {
                    transactionHistory = transactionHistory.slice(0, MAX_HISTORY_SIZE);
                }
                updateTransactionPanel();
            }

            function rollbackTransaction(transactionIndex) {
                if (transactionIndex >= 0 && transactionIndex < transactionHistory.length) {
                    const transaction = transactionHistory[transactionIndex];

                    // Restore from backup
                    Object.keys(transaction.backup).forEach(station => {
                        Object.keys(transaction.backup[station]).forEach(metricKey => {
                            const backupData = transaction.backup[station][metricKey];
                            const cell = document.getElementById(backupData.cellId);
                            if (cell) {
                                writeCellValue(cell, backupData.value, METRICS.find(m => m.key === metricKey).type);
                            }
                        });
                    });

                    // Remove this transaction and all newer ones from history
                    transactionHistory.splice(transactionIndex);
                    updateTransactionPanel();

                    showTransferStatus(`Rolled back to state before: ${transaction.description}`, 'success');
                }
            }

            // ==========================================
            // ATOMIC SWAP SYSTEM
            // ==========================================

            function atomicSwapStations(sourceStation, targetStation) {
                // Create backup before any changes (for undo functionality)
                const backup = createStateBackup([sourceStation, targetStation]);

                // SWAP PERSISTENCE: Register this swap with the state manager
                // This is critical - it tracks that these stations are swapped
                swapStateManager.registerSwap(sourceStation, targetStation);

                // Extract CURRENT values for both stations (from DOM)
                const sourceValues = {};
                const targetValues = {};

                METRICS.forEach(metric => {
                    const sourceCellId = `${sourceStation}_${metric.key}`;
                    const targetCellId = `${targetStation}_${metric.key}`;

                    const sourceCell = document.getElementById(sourceCellId);
                    const targetCell = document.getElementById(targetCellId);

                    if (sourceCell && targetCell) {
                        sourceValues[metric.key] = readCellValue(sourceCell, metric.type);
                        targetValues[metric.key] = readCellValue(targetCell, metric.type);
                    }
                });

                // Perform atomic swap - write target values to source and vice versa
                let swappedCount = 0;
                METRICS.forEach(metric => {
                    const sourceCellId = `${sourceStation}_${metric.key}`;
                    const targetCellId = `${targetStation}_${metric.key}`;

                    const sourceCell = document.getElementById(sourceCellId);
                    const targetCell = document.getElementById(targetCellId);

                    if (sourceCell && targetCell) {
                        // Write target's value to source
                        writeCellValue(sourceCell, targetValues[metric.key], metric.type);
                        // Write source's value to target
                        writeCellValue(targetCell, sourceValues[metric.key], metric.type);
                        swappedCount++;
                    }
                });

                // Add to transaction history (for undo functionality)
                addToTransactionHistory({
                    type: 'swap',
                    sourceStation: sourceStation,
                    targetStation: targetStation,
                    backup: backup,
                    timestamp: new Date(),
                    description: `Swapped all data between ${sourceStation} and ${targetStation}`
                });

                return swappedCount === METRICS.length;
            }

            // ==========================================
            // PREVIEW SYSTEM
            // ==========================================

            function showPreviewModal(sourceStation, targetStation) {
                // Get current values
                const sourceData = {};
                const targetData = {};

                METRICS.forEach(metric => {
                    const sourceCellId = `${sourceStation}_${metric.key}`;
                    const targetCellId = `${targetStation}_${metric.key}`;

                    const sourceCell = document.getElementById(sourceCellId);
                    const targetCell = document.getElementById(targetCellId);

                    if (sourceCell && targetCell) {
                        sourceData[metric.key] = {
                            current: sourceCell.textContent.trim() || 'â€”',
                            afterSwap: targetCell.textContent.trim() || 'â€”'
                        };
                        targetData[metric.key] = {
                            current: targetCell.textContent.trim() || 'â€”',
                            afterSwap: sourceCell.textContent.trim() || 'â€”'
                        };
                    }
                });

                // Create preview modal HTML
                const modalHTML = `
                    <div class="preview-modal" id="previewModal">
                        <div class="preview-content">
                            <div class="preview-header">
                                ðŸ”„ Transfer Preview: ${sourceStation} â†” ${targetStation}
                            </div>

                            <div class="preview-comparison">
                                <div class="station-preview">
                                    <h3>${sourceStation} (Source â†’ Target)</h3>
                                    ${METRICS.map(metric => `
                                        <div class="metric-row">
                                            <span>${metric.label}:</span>
                                            <span>${sourceData[metric.key].current} â†’ ${sourceData[metric.key].afterSwap}</span>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="station-preview">
                                    <h3>${targetStation} (Target â†’ Source)</h3>
                                    ${METRICS.map(metric => `
                                        <div class="metric-row">
                                            <span>${metric.label}:</span>
                                            <span>${targetData[metric.key].current} â†’ ${targetData[metric.key].afterSwap}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="preview-buttons">
                                <button class="preview-btn confirm" onclick="confirmSwap('${sourceStation}', '${targetStation}')">
                                    âœ… Confirm Swap
                                </button>
                                <button class="preview-btn cancel" onclick="cancelSwap()">
                                    âŒ Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            function confirmSwap(sourceStation, targetStation) {
                // Remove preview modal
                const modal = document.getElementById('previewModal');
                if (modal) modal.remove();

                // Highlight both stations
                clearHighlights();
                highlightStationSameColor(sourceStation, 3000);
                highlightStationSameColor(targetStation, 3000);

                // Show transfer status
                showTransferStatus('ðŸ”„ Swapping station data...');

                // Execute the swap with a slight delay for visual feedback
                setTimeout(() => {
                    executeAtomicSwap(sourceStation, targetStation);
                }, 500);
            }

            function cancelSwap() {
                const modal = document.getElementById('previewModal');
                if (modal) modal.remove();
            }

            // Main transfer function (called after confirmation)
            function executeAtomicSwap(sourceStation, targetStation) {
                const success = atomicSwapStations(sourceStation, targetStation);

                if (success) {
                    showTransferStatus(`âœ… Successfully swapped all data between ${sourceStation} and ${targetStation}!`, 'success');
                } else {
                    showTransferStatus(`âŒ Transfer failed. Some data could not be swapped.`, 'error');
                }

                return success;
            }

            // Enhanced transfer function with preview
            function transferEverythingWithPreview() {
                const src = document.getElementById("masterSource").value;
                const dst = document.getElementById("masterTarget").value;

                if (src === dst) {
                    alert("Source and target must be different.");
                    return false;
                }

                if (!src || !dst) {
                    alert("Please select both source and target stations.");
                    return false;
                }

                showPreviewModal(src, dst);
                return false; // Don't proceed until user confirms
            }

            // Enhanced transfer function with source zeroing
            function transferAndZeroSource(sourceCellId, targetCellId, type, mode = "add") {
                const sCell = document.getElementById(sourceCellId);
                const tCell = document.getElementById(targetCellId);
                if (!sCell || !tCell) {
                    console.warn("Missing cells:", sourceCellId, targetCellId);
                    return false;
                }

                const s = readCellValue(sCell, type);
                const t = readCellValue(tCell, type);
                if (s === null || t === null) {
                    console.warn("Invalid numeric values:", sourceCellId, targetCellId);
                    return false;
                }

                let next = t || 0;
                if (mode === "add") {
                    next = (t || 0) + (s || 0);
                } else if (mode === "copy") {
                    next = s;
                }

                // Transfer to target
                writeCellValue(tCell, next, type);

                // Zero out source
                writeCellValue(sCell, 0, type);

                return true;
            }

            // Main enhanced transfer function
            function transferEverythingWithZero() {
                const src = document.getElementById("masterSource").value;
                const dst = document.getElementById("masterTarget").value;

                if (src === dst) {
                    alert("Source and target must be different.");
                    return false;
                }

                let ok = 0;
                for (const m of METRICS) {
                    const sId = `${src}_${m.key}`;
                    const tId = `${dst}_${m.key}`;
                    if (transferAndZeroSource(sId, tId, m.type, m.mode)) {
                        ok++;
                    }
                }

                if (ok === METRICS.length) {
                    showTransferStatus(`Successfully transferred ${ok} metrics from ${src} to ${dst} and zeroed source!`, 'success');
                } else {
                    showTransferStatus(`Transferred ${ok}/${METRICS.length} metrics (see console for details)`, 'warning');
                }

                return ok === METRICS.length;
            }

            // Enhanced highlight function - SAME COLOR for both source and target
            function clearHighlights() {
                document.querySelectorAll(
                    '.table-highlight-active,.cell-highlight-active'
                ).forEach(el => el.classList.remove(
                    'table-highlight-active', 'cell-highlight-active'
                ));
            }

            // Highlight with SAME COLOR for both source and target
            function highlightStationSameColor(station, duration = 3000) {
                const cells = document.querySelectorAll(`[id^="${station}_"]`);
                const tables = new Set();

                cells.forEach(cell => {
                    // Mark the cell with same color for both source and target
                    cell.classList.add('cell-highlight-active');
                    const td = cell.closest('td') || cell;
                    td.classList.add('cell-highlight-active');

                    // Mark the table with same color
                    const table = cell.closest('table');
                    if (table) {
                        table.classList.add('table-highlight-active');
                        tables.add(table);
                    }
                });

                if (duration > 0) {
                    setTimeout(() => {
                        cells.forEach(cell => {
                            cell.classList.remove('cell-highlight-active');
                            const td = cell.closest('td') || cell;
                            td.classList.remove('cell-highlight-active');
                        });
                        tables.forEach(t => t.classList.remove('table-highlight-active'));
                    }, duration);
                }
            }

            // Show transfer status
            function showTransferStatus(message, type = 'info') {
                const statusDiv = document.getElementById('transferStatus');
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';

                if (type === 'success') {
                    statusDiv.style.borderColor = '#27ae60';
                } else if (type === 'warning') {
                    statusDiv.style.borderColor = '#f39c12';
                } else {
                    statusDiv.style.borderColor = '#3498db';
                }

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 2000);
            }

            // Enhanced main transfer handler
            // ==========================================
            // TRANSACTION HISTORY UI
            // ==========================================

            function updateTransactionPanel() {
                let panel = document.getElementById('transactionPanel');

                if (!panel) {
                    // Create transaction panel if it doesn't exist
                    const panelHTML = `
                        <div id="transactionPanel" class="transaction-panel" style="display: none;">
                            <h3 style="color: #3498db; text-align: center; margin-bottom: 20px;">ðŸ“‹ Transaction History</h3>
                            <div id="transactionList"></div>
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="toggleTransactionPanel()" class="transfer-btn">
                                    Hide History
                                </button>
                                <button onclick="clearTransactionHistory()" class="transfer-btn" style="background: #e74c3c; margin-left: 10px;">
                                    Clear History
                                </button>
                            </div>
                        </div>
                    `;

                    // Insert after transfer section
                    const transferSection = document.querySelector('.transfer-section');
                    if (transferSection) {
                        transferSection.insertAdjacentHTML('afterend', panelHTML);
                        panel = document.getElementById('transactionPanel');
                    }
                }

                const transactionList = document.getElementById('transactionList');
                if (transactionList) {
                    if (transactionHistory.length === 0) {
                        transactionList.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 20px;">No transactions yet</div>';
                    } else {
                        transactionList.innerHTML = transactionHistory.map((transaction, index) => `
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <strong>${transaction.description}</strong><br>
                                    <small style="color: #bdc3c7;">${transaction.timestamp.toLocaleString()}</small>
                                </div>
                                <div class="transaction-actions">
                                    <button class="undo-btn" onclick="rollbackTransaction(${index})"
                                            title="Rollback to this state">
                                        â†¶ Undo
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }

            function toggleTransactionPanel() {
                const panel = document.getElementById('transactionPanel');
                if (panel) {
                    if (panel.style.display === 'none') {
                        panel.style.display = 'block';
                        updateTransactionPanel();
                    } else {
                        panel.style.display = 'none';
                    }
                }
            }

            function clearTransactionHistory() {
                if (confirm('Are you sure you want to clear all transaction history? This cannot be undone.')) {
                    transactionHistory = [];
                    updateTransactionPanel();
                    showTransferStatus('Transaction history cleared', 'success');
                }
            }

            // Enhanced main transfer handler with all safety features
            function handleEnhancedTransfer() {
                const btn = document.getElementById('transferBtn');
                btn.disabled = true;

                const src = document.getElementById('masterSource').value;
                const dst = document.getElementById('masterTarget').value;

                if (src === dst) {
                    alert('Source and target must be different.');
                    btn.disabled = false;
                    return;
                }

                if (!src || !dst) {
                    alert('Please select both source and target stations.');
                    btn.disabled = false;
                    return;
                }

                // Show preview instead of immediate transfer
                try {
                    transferEverythingWithPreview();
                } finally {
                    setTimeout(() => (btn.disabled = false), 500);
                }
            }

            // ==========================================
            // EXISTING FUNCTIONALITY (preserved)
            // ==========================================

            function GetNow() {
                var currentdate = new Date();
                var datetime = currentdate.getFullYear() + "-" +
                    (currentdate.getMonth() + 1) + "-" +
                    currentdate.getDate() + " " +
                    ("0" + currentdate.getHours()).slice(-2) + ":" +
                    ("0" + currentdate.getMinutes()).slice(-2) + ":" +
                    ("0" + currentdate.getSeconds()).slice(-2);
                return datetime;
            }

            var criteria = '99'; // Default to 'Final'

            // Function to handle selection of query criteria
            function selectCriteria(c) {
                criteria = c;
                // Toggle 'active' class for buttons
                $('.button').removeClass('active');
                $('button[data-criteria="' + c + '"]').addClass('active');

                // Reset data load state for new criteria
                dataLoadState.reset();
                console.log(`ðŸ”„ Loading data for criteria: ${c}`);

                // Reload data based on the selected criteria
                loadOutboundValues($("#sortSel").val(), criteria);
                loadExceptionValues($("#sortSel").val(), criteria);
                loadSmallsValues($("#sortSel").val(), criteria);
                loadIrregValues($("#sortSel").val(), criteria);
                loadPrimaryValues($("#sortSel").val(), criteria);
            }

            // Function to load outbound values based on selected criteria
            function loadOutboundValues(SortID, Criteria) {
                // SWAP PERSISTENCE: Preserve swap state before data load
                const preservedStations = swapInterceptor.beforeDataLoad();

                //Load the hourly values
                $.ajax({
                    url: "HourlyQuicklookServer_DATA.aspx?sortid=" + SortID + "&hourid=" + Criteria,
                    success: function (data) {
                        //Clear the table from current values

                        //Clear the table from current values
                        $('#South tr').each(function (index) {

                            if (index != 0 && index != 1 && index != 8) {
                                $.each(this.cells, function (index) {
                                    if (index < 6) {
                                        $(this).text("");
                                    }

                                });

                            }
                        });

                        //Clear the table from current values
                        $('#North tr').each(function (index) {

                            if (index != 0 && index != 1 && index != 8) {
                                $.each(this.cells, function (index) {
                                    if (index > 0) {
                                        $(this).text("");
                                    }

                                });

                            }
                        });

                        names = Array("S11", "S12", "S13", "S14", "S15", "S16", "S17", "S18", "S19", "S20", "S21", "S22"
                            , "S01", "S02", "S03", "S04", "S05", "S06", "S07", "S08", "S09", "S10"
                            , "OB01", "OB02", "OB03", "OB04", "OB05", "OB06", "OB07", "OB08", "OB09", "OB10"
                            , "North", "South");

                        for (n of names) {

                            //console.log(data[0]["Outbound_" + n + "_Chutefull"])
                            $("#" + n + "_CF").text(data[0]["Outbound_" + n + "_Chutefull"].toLocaleString())
                            $("#" + n + "_BS").text(data[0]["Outbound_" + n + "_Beltstop"])
                            $("#" + n + "_UTPct").text(data[0]["Outbound_" + n + "_UTPct"].toFixed(2) + "%")
                            $("#" + n + "_Vol").text(data[0]["Outbound_" + n + "_InputVolume"].toLocaleString())
                            $("#" + n + "_DecPct").text(data[0]["Outbound_" + n + "_Decline"] + "%")
                            $("#" + n + "_CFPct").text(data[0]["Outbound_" + n + "_CFPct"] + "%")
                        }

                        // Mark outbound data as loaded
                        dataLoadState.markLoaded('outbound');

                        // SWAP PERSISTENCE: Queue restoration
                        swapRestorationQueue.add('outbound-data-refresh');
                    }
                });
            }

            // New edits | 7/9/25 | W.Rodriguez

            function loadExceptionValues(SortID, Criteria) {
                // SWAP PERSISTENCE: Preserve swap state before data load
                const preservedStations = swapInterceptor.beforeDataLoad();

                //Load the hourly values
                $.ajax({
                    url: "HourlyQuicklookServer_DATA.aspx?sortid=" + SortID + "&hourid=" + Criteria,
                    success: function (data) {
                        //Clear the table from current values

                        //Clear the table from current values
                        $('Exceptions th').each(function (index) {

                            if (index != 0 && index != 1 && index != 8) {
                                $.each(this.cells, function (index) {
                                    if (index < 6) {
                                        $(this).text("");
                                    }

                                });

                            }
                        });

                        names = Array("RC01", "RC02", "RC03", "RC04", "DA1C", "DA02", "SSR1", "SSR2", "SSR3");

                        for (n of names) {

                            $("#" + n + "_UTPct").text(data[0]["Exceptions_" + n + "_UTPct"].toFixed(2) + "%")

                        }

                        // Mark exceptions data as loaded
                        dataLoadState.markLoaded('exceptions');

                        // SWAP PERSISTENCE: Queue restoration
                        swapRestorationQueue.add('exceptions-data-refresh');
                    }
                });
            }
            // New edits | 7/10/25 | W.Rodriguez

            function loadSmallsValues(SortID, Criteria) {
                // SWAP PERSISTENCE: Preserve swap state before data load
                const preservedStations = swapInterceptor.beforeDataLoad();

                //Load the hourly values
                $.ajax({
                    url: "HourlyQuicklookServer_DATA.aspx?sortid=" + SortID + "&hourid=" + Criteria,
                    success: function (data) {
                        //Clear the table from current values

                        //Clear the table from current values
                        $('Smalls th').each(function (index) {

                            if (index != 0 && index != 1 && index != 8) {
                                $.each(this.cells, function (index) {
                                    if (index < 6) {
                                        $(this).text("");
                                    }

                                });

                            }
                        });

                        names = Array("BF1", "BF2", "BF9", "SLS03", "SLS04", "SLS10", "SLS11", "SLS12", "SLS13", "SLS14", "SLS15", "SLS16", "SS1F1", "SS3F1", "SS4F1");

                        for (n of names) {

                            //$("#" + n + "_UTPct").text(data[0]["Exceptions_" + n + "_UTPct"].toFixed(2)+"%")
                            $("#" + n + "_UTPct").text(data[0]["Smalls_" + n + "_UTPct"].toFixed(2) + "%")

                        }

                        // Mark smalls data as loaded
                        dataLoadState.markLoaded('smalls');

                        // SWAP PERSISTENCE: Queue restoration
                        swapRestorationQueue.add('smalls-data-refresh');
                    }
                });
            }

            // New edits | 7/16/26 | W.Rodriguez

            function loadIrregValues(SortID, Criteria) {
                // SWAP PERSISTENCE: Preserve swap state before data load
                const preservedStations = swapInterceptor.beforeDataLoad();

                //Load the hourly values
                $.ajax({
                    url: "HourlyQuicklookServer_DATA.aspx?sortid=" + SortID + "&hourid=" + Criteria,
                    success: function (data) {
                        //Clear the table from current values

                        //Clear the table from current values
                        $('Exceptions th').each(function (index) {

                            if (index != 0 && index != 1 && index != 8) {
                                $.each(this.cells, function (index) {
                                    if (index < 6) {
                                        $(this).text("");
                                    }

                                });

                            }
                        });

                        names = Array("IR1_D01", "IR1_D02", "IR1_D03", "IR1_D04", "IR1_D05", "IR2_D06", "IR2_D07", "IR2_D08", "IR2_D09", "IR2_D10", "IR2_F1", "IR2_F2", "IR1_F1", "IR1_F2");

                        for (n of names) {

                            $("#" + n + "_UTPct").text(data[0]["Irreg_" + n + "_UTPct"].toFixed(2) + "%")

                        }

                        // Mark irreg data as loaded
                        dataLoadState.markLoaded('irreg');

                        // SWAP PERSISTENCE: Queue restoration
                        swapRestorationQueue.add('irreg-data-refresh');
                    }
                });
            }

            function loadPrimaryValues(SortID, Criteria) {
                // SWAP PERSISTENCE: Preserve swap state before data load
                const preservedStations = swapInterceptor.beforeDataLoad();

                //Load the hourly values
                $.ajax({
                    url: "HourlyQuicklookServer_DATA.aspx?sortid=" + SortID + "&hourid=" + Criteria,
                    success: function (data) {
                        //Clear the table from current values

                        //Clear the table from current values
                        $('Primary').each(function (index) {

                            if (index != 0 && index != 1 && index != 8) {
                                $.each(this.cells, function (index) {
                                    if (index < 6) {
                                        $(this).text("");
                                    }

                                });

                            }
                        });

                        //"Total","NoReads"
                        names = Array("NW", "NE", "SW", "SE", "Total", "NoReads");

                        for (n of names) {

                            $("#" + n + "_InputVolume").text(data[0]["Primary_" + n + "_InputVolume"].toLocaleString())
                            $("#" + n + "_BeltStops").text(data[0]["Primary_" + n + "_BeltStops"])
                            $("#" + n + "_NoReadsPct").text(data[0]["Primary_" + n + "_NoReadsPct"].toFixed(2) + "%")
                            // $("#" + n + "_Total").text(data[0]["Primary_" + n + "_Total"].toFixed(2)+"%")
                        }

                        // Mark primary data as loaded
                        dataLoadState.markLoaded('primary');

                        // SWAP PERSISTENCE: Queue restoration
                        swapRestorationQueue.add('primary-data-refresh');
                    }
                });
            }

            function openPrintDialog() {
                window.print();
            }

            // Sample data for testing the enhanced transfer system
            function addSampleDataForTesting() {
                const sampleData = {
                    'S01_Vol': '2,150', 'S01_BS': '12', 'S01_UTPct': '96.8%', 'S01_DecPct': '1.2%', 'S01_CF': '4', 'S01_CFPct': '2.9%',
                    'S02_Vol': '1,750', 'S02_BS': '20', 'S02_UTPct': '91.4%', 'S02_DecPct': '2.8%', 'S02_CF': '9', 'S02_CFPct': '6.1%',
                    'S11_Vol': '3,250', 'S11_BS': '15', 'S11_UTPct': '92.5%', 'S11_DecPct': '2.1%', 'S11_CF': '8', 'S11_CFPct': '5.3%',
                    'S12_Vol': '980', 'S12_BS': '22', 'S12_UTPct': '88.7%', 'S12_DecPct': '3.2%', 'S12_CF': '12', 'S12_CFPct': '7.8%',
                    'S13_Vol': '1,850', 'S13_BS': '18', 'S13_UTPct': '94.1%', 'S13_DecPct': '1.8%', 'S13_CF': '6', 'S13_CFPct': '4.2%',
                    'S21_Vol': '2,720', 'S21_BS': '14', 'S21_UTPct': '93.7%', 'S21_DecPct': '2.3%', 'S21_CF': '7', 'S21_CFPct': '4.8%'
                };

                Object.entries(sampleData).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });

                showTransferStatus('âœ… Sample data loaded successfully! Now you can test the enhanced transfer system.', 'success');
            }

            // ==========================================
            // SWAP MANAGEMENT UI FUNCTIONS
            // ==========================================

            // Clear all active swaps and restore original data
            function clearAllSwaps() {
                if (swapStateManager.getAllSwappedStations().length === 0) {
                    showTransferStatus('No active swaps to clear', 'info');
                    return;
                }

                const confirmMsg = `Are you sure you want to clear all active swaps?\n\nThis will restore all stations to their original server data.`;
                if (!confirm(confirmMsg)) {
                    return;
                }

                // Get list of stations to restore
                const swappedStations = swapStateManager.getAllSwappedStations();

                // Clear the swap state (this will trigger cross-tab sync)
                swapStateManager.clearAllSwaps();

                // Clear the restoration queue
                swapRestorationQueue.clear();

                // Force reload of data to restore original values
                console.log('ðŸ”„ Clearing swaps - reloading fresh data from server...');
                const currentSortId = $("#sortSel").val();
                const currentCriteria = criteria;

                // Reset data load state
                dataLoadState.reset();

                // Reload all data functions to get fresh server data
                loadOutboundValues(currentSortId, currentCriteria);
                loadExceptionValues(currentSortId, currentCriteria);
                loadSmallsValues(currentSortId, currentCriteria);
                loadIrregValues(currentSortId, currentCriteria);
                loadPrimaryValues(currentSortId, currentCriteria);

                // Update the UI display
                refreshSwapDisplay();

                showTransferStatus(`âœ… Cleared all swaps and restored ${swappedStations.length} stations to original data`, 'success');
            }

            // Update the swap display in the UI
            function refreshSwapDisplay() {
                const swapsList = document.getElementById('swapsList');
                const swapSummary = swapStateManager.getSwapSummary();

                if (swapSummary.length === 0) {
                    swapsList.innerHTML = 'No active swaps';
                    swapsList.style.color = '#95a5a6';
                } else {
                    const swapTexts = swapSummary.map(swap =>
                        `<span style="background: rgba(231, 76, 60, 0.2); padding: 2px 6px; border-radius: 4px; margin: 2px;">${swap.source} â†” ${swap.target}</span>`
                    );
                    swapsList.innerHTML = swapTexts.join(' ') +
                        ' <span style="color: #3498db; margin-left: 10px;">ðŸ”„ Synced across all tabs</span>';
                    swapsList.style.color = '#e74c3c';
                }

                // Update status info
                const statusInfo = document.getElementById('swapStatusInfo');
                if (swapSummary.length > 0) {
                    statusInfo.innerHTML = `${swapSummary.length} active swap(s) - Synchronized across all browser tabs`;
                    statusInfo.style.color = '#f39c12';
                } else {
                    statusInfo.innerHTML = 'Swaps will persist across tabs, hour changes, and auto-refresh cycles';
                    statusInfo.style.color = '#bdc3c7';
                }
            }

            // Show debug information about current swap state
            function showSwapDebugInfo() {
                console.log('=== SWAP DEBUG INFO ===');
                console.log('Active Swaps:', Array.from(swapStateManager.activeSwaps.entries()));
                console.log('Swap Summary:', swapStateManager.getSwapSummary());
                console.log('Transaction History Length:', transactionHistory.length);
                console.log('Data Load State:', dataLoadState);
                console.log('LocalStorage Swaps:', crossTabSwapSync.loadSwapState());

                // Show summary in UI
                const swapSummary = swapStateManager.getSwapSummary();
                const debugMsg = `Debug Info (see console for details):

Active Swaps: ${swapSummary.length}
All Data Loaded: ${dataLoadState.isAllDataLoaded()}
Transaction History: ${transactionHistory.length} entries
Tab ID: ${crossTabSwapSync.TAB_ID}

Swaps: ${swapSummary.map(s => `${s.source}â†”${s.target}`).join(', ') || 'None'}`;

                alert(debugMsg);
            }

            // Auto-refresh the swap display when swaps change
            // Hook into existing swap completion
            const originalExecuteAtomicSwap = executeAtomicSwap;
            window.executeAtomicSwap = function(sourceStation, targetStation) {
                const result = originalExecuteAtomicSwap(sourceStation, targetStation);
                setTimeout(() => refreshSwapDisplay(), 200);
                return result;
            };

            // Initialize swap display on page load
            setTimeout(() => {
                refreshSwapDisplay();
            }, 1000);

        </script>

</body>

</html>